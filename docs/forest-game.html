<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ² Ù„Ø¹Ø¨Ø© Ø§Ù„ØºØ§Ø¨Ø© - Ø§ÙƒØªØ´Ù Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016, #4a7c59, #2d5016);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .back-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 12px;
            width: 45px;
            height: 40px;
            color: white;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
            background: linear-gradient(135deg, #ff5252, #e53935);
        }

        .back-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .game-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .score-display {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a202c;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª */
        .coins-display {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .coin-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .coin-icon {
            font-size: 1.5em;
        }

        #coins-count {
            color: #ffd700;
            font-size: 1.3em;
        }

        .game-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9em;
            color: #cbd5e0;
        }

        /* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ */
        .player-info {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-avatar {
            flex-shrink: 0;
        }

        .player-details {
            flex: 1;
        }

        .player-balance {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: right;
        }

        /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #cbd5e0;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ */
        .game-area {
            background: linear-gradient(135deg, #1a4d2e, #2d5016);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
            position: relative;
            border: 3px solid rgba(255, 215, 0, 0.3);
        }

        /* Ù‡Ø¯Ù Ø§Ù„Ø¨Ø­Ø« */
        .target-animal {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .target-animal h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .target-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .target-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #ffd700;
        }

        .target-details {
            color: #e2e8f0;
        }

        .target-reward {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ù‚ÙØ§Øµ */
        .cages-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            max-width: 100%;
            padding: 0 10px;
        }

        .cage {
            background: linear-gradient(135deg, #8B4513, #CD853F, #DEB887);
            border: 3px solid #654321;
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .cage:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
            border-color: #ffd700;
        }

        .cage.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .cage-cover {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 5px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
        }

        .cage-number {
            position: absolute;
            top: 3px;
            left: 3px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a202c;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            border: 2px solid #654321;
        }

        .cage-content {
            display: none;
        }

        .cage.opened .cage-cover {
            display: none;
        }

        .cage.opened .cage-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        /* ØªØ£Ø«ÙŠØ± ÙØªØ­ Ø§Ù„Ù‚ÙØµ */
        .cage.opening .cage-cover {
            animation: cageOpen 0.5s ease-out forwards;
        }

        @keyframes cageOpen {
            0% {
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.1) rotateY(90deg);
                opacity: 0.5;
            }
            100% {
                transform: scale(0) rotateY(180deg);
                opacity: 0;
                display: none;
            }
        }

        .revealed-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ffd700;
        }

        .revealed-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 0.7em;
            margin: 2px 0;
        }

        .revealed-result {
            padding: 3px 6px;
            border-radius: 6px;
            font-size: 0.6em;
            font-weight: bold;
            margin-top: 2px;
        }

        .result-win {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .result-lose {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .result-target {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a202c;
        }

        .result-multiplier {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            animation: glow 1s ease-in-out infinite alternate;
        }

        .result-double-loss {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .message.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .message.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .message.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width: 768px) {
            .game-container {
                margin: 2px;
                padding: 5px;
                max-width: 100vw;
                box-sizing: border-box;
            }

            .header {
                margin-bottom: 5px;
                padding: 4px 6px;
                flex-wrap: wrap;
            }

            .game-title {
                font-size: 0.9em;
                order: 1;
                flex: 1;
                text-align: center;
            }

            .back-btn {
                width: 35px;
                height: 32px;
                font-size: 1.1em;
                order: 0;
                border-radius: 8px;
            }

            .coins-display {
                padding: 6px;
                margin: 5px 0;
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }

            .coin-counter {
                font-size: 1em;
            }

            .game-info {
                font-size: 0.7em;
            }

            .player-info {
                padding: 8px;
                margin: 8px 0;
                gap: 8px;
            }

            .player-info img {
                width: 35px !important;
                height: 35px !important;
            }

            .player-details {
                font-size: 0.8em;
            }

            .player-balance {
                font-size: 0.8em;
                gap: 3px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
                margin: 5px 0;
            }

            .stat-item {
                padding: 6px;
            }

            .stat-value {
                font-size: 1em;
            }

            .stat-label {
                font-size: 0.7em;
            }

            .game-area {
                padding: 10px;
                margin: 5px 0;
                min-height: 300px;
            }

            .target-animal {
                padding: 10px;
                margin-bottom: 10px;
            }

            .target-animal h3 {
                font-size: 1em;
                margin-bottom: 8px;
            }

            .target-image {
                width: 40px;
                height: 40px;
            }

            .target-details {
                font-size: 0.8em;
            }

            .target-reward {
                padding: 4px 8px;
                font-size: 0.7em;
            }

            .cages-grid {
                gap: 5px;
                margin: 10px 0;
                padding: 0 5px;
            }

            .cage {
                min-height: 60px;
                padding: 5px;
                border-radius: 8px;
            }

            .cage-cover {
                width: 35px;
                height: 35px;
                margin-bottom: 2px;
            }

            .cage-number {
                width: 16px;
                height: 16px;
                font-size: 0.6em;
                top: 2px;
                left: 2px;
            }

            .revealed-image {
                width: 30px;
                height: 30px;
            }

            .revealed-name {
                font-size: 0.6em;
            }

            .revealed-result {
                font-size: 0.5em;
                padding: 2px 4px;
            }

            .controls {
                gap: 5px;
                margin: 5px 0;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 0.7em;
                flex: 1;
                min-width: 80px;
            }

            #start-message {
                font-size: 0.9em;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <div class="header">
            <button class="back-btn" onclick="goBack()" title="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">â†</button>
            <h1 class="game-title">ğŸŒ² Ù„Ø¹Ø¨Ø© Ø§Ù„ØºØ§Ø¨Ø©</h1>
            <div class="score-display">
                Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span>
            </div>
        </div>

        <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Øª -->
        <div class="coins-display">
            <div class="coin-counter">
                <span class="coin-icon">ğŸ’°</span>
                <span id="coins-count">1000</span>
                <span class="coin-label">Ø¹Ù…Ù„Ø©</span>
            </div>
            <div class="game-info">
                <span>ğŸ¯ ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬ÙˆÙ„Ø©: <span id="bet-amount">50</span> Ø¹Ù…Ù„Ø©</span>
                <span>ğŸ† Ù…ÙƒØ§ÙØ¢Øª: Ø¹Ø§Ø¯ÙŠØ©ØŒ Ù…Ø¶Ø§Ø¹Ù x5/x8/x10ØŒ Ø§Ø³ØªØ±Ø¯Ø§Ø¯</span>
                <span>ğŸ’€ Ù…Ø®Ø§Ø·Ø±: ÙˆØ­ÙˆØ´ØŒ Ø®Ø³Ø§Ø±Ø© Ù…Ø¶Ø§Ø¹ÙØ©</span>
            </div>
        </div>

        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
        <div class="player-info" id="player-info" style="display: none;">
            <div class="player-avatar">
                <img id="player-avatar" src="/images/default-avatar.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨"
                     style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ffd700;">
            </div>
            <div class="player-details">
                <div id="player-name" style="font-weight: bold; color: #ffd700;">Ø§Ù„Ù„Ø§Ø¹Ø¨</div>
                <div id="player-level" style="color: #cbd5e0; font-size: 0.9em;">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1</div>
            </div>
            <div class="player-balance">
                <div style="color: #10b981; font-weight: bold;">
                    ğŸ’° <span id="player-gold">0</span>
                </div>
                <div style="color: #3b82f6; font-weight: bold;">
                    ğŸ’ <span id="player-pearls">0</span>
                </div>
            </div>
        </div>

        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="discovered">0</div>
                <div class="stat-label">Ø¬ÙˆÙ„Ø§Øª</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="correct">0</div>
                <div class="stat-label">ÙÙˆØ²</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="wrong">0</div>
                <div class="stat-label">Ø®Ø³Ø§Ø±Ø©</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="level">1</div>
                <div class="stat-label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</div>
            </div>
        </div>

        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨ -->
        <div class="game-area">
            <!-- Ù‡Ø¯Ù Ø§Ù„Ø¨Ø­Ø« -->
            <div class="target-animal" id="target-animal" style="display: none;">
                <h3>ğŸ¯ Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†:</h3>
                <div class="target-info">
                    <img id="target-image" class="target-image" src="" alt="">
                    <div class="target-details">
                        <div id="target-name" style="font-size: 1.2em; font-weight: bold; color: #ffd700;"></div>
                        <div style="margin: 5px 0;">Ø¥Ø°Ø§ ÙˆØ¬Ø¯ØªÙ‡:</div>
                        <div class="target-reward" id="target-reward">+0 Ø¹Ù…Ù„Ø©</div>
                    </div>
                </div>
            </div>

            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ù‚ÙØ§Øµ -->
            <div class="cages-grid" id="cages-grid">
                <!-- Ø§Ù„Ø£Ù‚ÙØ§Øµ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
            </div>

            <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
            <div id="start-message" style="text-align: center; color: #ffd700; font-size: 1.2em; display: none;">
                ğŸŒ² Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØºØ§Ø¨Ø©!<br>
                Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚Ø§Ù‹ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®ÙÙŠØ©
            </div>
        </div>

        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="controls">
            <button class="control-btn" onclick="enableAudio(); playSound('click'); startGame()">ğŸ”„ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
            <button class="control-btn" onclick="enableAudio(); playSound('click'); resetGame()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
            <button class="control-btn" onclick="refreshPlayerData()">ğŸ‘¤ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="control-btn" onclick="toggleSound()" id="sound-btn">ğŸ”Š Ø§Ù„ØµÙˆØª</button>
        </div>
    </div>

    <script src="/js/player-header.js"></script>
    <script src="/js/game-economy.js"></script>
    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let gameState = {
            score: 0,
            coins: 1000,
            gamesPlayed: 0,
            wins: 0,
            losses: 0,
            level: 1,
            isPlaying: false,
            targetAnimal: null,
            cageContents: [],
            soundEnabled: true,
            betAmount: 50, // ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬ÙˆÙ„Ø©
            economySession: null
        };

        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„Ù…Ø¶Ø§Ø¹ÙØ§Øª ÙˆØ§Ù„ØªØ£Ø«ÙŠØ±Ø§Øª
        const animals = [
            // Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø¹Ø§Ø¯ÙŠØ© (ØªØ¹Ø·ÙŠ Ù†Ù‚Ø§Ø· Ø¹Ø§Ø¯ÙŠØ©)
            { name: 'ÙƒÙ„Ø¨', image: 'dog.png', points: 80, type: 'normal', effect: 'normal' },
            { name: 'Ù‚Ø·Ø©', image: 'cat.png', points: 70, type: 'normal', effect: 'normal' },
            { name: 'Ø¨Ù‚Ø±Ø©', image: 'cow.png', points: 90, type: 'normal', effect: 'normal' },
            { name: 'Ø®Ø±ÙˆÙ', image: 'sheep.png', points: 85, type: 'normal', effect: 'normal' },
            { name: 'Ø¯ÙŠÙƒ', image: 'rooster.png', points: 60, type: 'normal', effect: 'normal' },
            { name: 'Ø¨Ø·Ø©', image: 'duck.png', points: 65, type: 'normal', effect: 'normal' },
            { name: 'Ø£Ø±Ù†Ø¨', image: 'rabbit.png', points: 75, type: 'normal', effect: 'normal' },
            { name: 'Ø¶ÙØ¯Ø¹', image: 'frog.png', points: 55, type: 'normal', effect: 'normal' },
            { name: 'Ø³Ù…ÙƒØ©', image: 'fish.png', points: 50, type: 'normal', effect: 'normal' },
            { name: 'Ø¯Ø¬Ø§Ø¬Ø©', image: 'chicken.png', points: 55, type: 'normal', effect: 'normal' },
            { name: 'Ø­Ù…Ø§Ø±', image: 'donkey.png', points: 70, type: 'normal', effect: 'normal' },
            { name: 'Ø¨Ø·Ø±ÙŠÙ‚', image: 'pinguin.png', points: 105, type: 'normal', effect: 'normal' },

            // Ø­ÙŠÙˆØ§Ù†Ø§Øª ØªØ¹ÙŠØ¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬ÙˆÙ„Ø© ÙÙ‚Ø·
            { name: 'Ù‚Ø±Ø¯', image: 'monkey.png', points: 0, type: 'refund', effect: 'refund' },
            { name: 'ÙƒÙˆØ§Ù„Ø§', image: 'koala.png', points: 0, type: 'refund', effect: 'refund' },
            { name: 'Ø±Ø§ÙƒÙˆÙ†', image: 'raccoon.png', points: 0, type: 'refund', effect: 'refund' },

            // Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ø¶Ø§Ø¹Ù x5
            { name: 'Ø­ØµØ§Ù†', image: 'horse.png', points: 0, type: 'multiplier', effect: 'x5', multiplier: 5 },
            { name: 'Ø¬Ù…Ù„', image: 'camel.png', points: 0, type: 'multiplier', effect: 'x5', multiplier: 5 },
            { name: 'ØºØ²Ø§Ù„', image: 'deer.png', points: 0, type: 'multiplier', effect: 'x5', multiplier: 5 },

            // Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ø¶Ø§Ø¹Ù x8
            { name: 'Ø°Ø¦Ø¨', image: 'wolf.png', points: 0, type: 'multiplier', effect: 'x8', multiplier: 8 },
            { name: 'Ù†Ø³Ø±', image: 'eagle.png', points: 0, type: 'multiplier', effect: 'x8', multiplier: 8 },
            { name: 'Ø¨ÙˆÙ…Ø©', image: 'owl.png', points: 0, type: 'multiplier', effect: 'x8', multiplier: 8 },

            // Ø­ÙŠÙˆØ§Ù†Ø§Øª Ù…Ø¶Ø§Ø¹Ù x10
            { name: 'Ø£Ø³Ø¯', image: 'lion.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },
            { name: 'ÙÙŠÙ„', image: 'elephant.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },
            { name: 'Ù†Ù…Ø±', image: 'tiger.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },
            { name: 'Ø²Ø±Ø§ÙØ©', image: 'giraffe.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },
            { name: 'Ø¨Ø§Ù†Ø¯Ø§', image: 'panda.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },

            // Ø­ÙŠÙˆØ§Ù†Ø§Øª ØªØ£Ø®Ø° Ù‚ÙŠÙ…Ø© Ø¬ÙˆÙ„ØªÙŠÙ†
            { name: 'ÙƒÙ†ØºØ±', image: 'kangaroo.png', points: 0, type: 'double_loss', effect: 'double_loss' },
            { name: 'Ø¨Ø¨ØºØ§Ø¡', image: 'parrot.png', points: 0, type: 'double_loss', effect: 'double_loss' }
        ];

        // Ø§Ù„ÙˆØ­ÙˆØ´ (ØªØ³Ø¨Ø¨ Ø§Ù„Ø®Ø³Ø§Ø±Ø©)
        const monsters = [
            { name: 'ÙˆØ­Ø´', image: 'monster.png', type: 'monster' },
            { name: 'Ø´Ø¨Ø­', image: 'Ghost.png', type: 'monster' },
            { name: 'Ø´Ø¨Ø­ Ø¢Ø®Ø±', image: 'Ghost 2.png', type: 'monster' },
            { name: 'Ø¹ÙØ±ÙŠØª', image: 'default-avatar.png', type: 'monster' }
        ];

        // Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØµÙˆØ§Øª
        let audioContext;
        let audioInitialized = false;

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('ğŸ”Š ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª - Ù„Ø¹Ø¨Ø© Ø§Ù„ØºØ§Ø¨Ø©');
            } catch (error) {
                console.log('ğŸ”‡ Web Audio API ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…');
                gameState.soundEnabled = false;
            }
        }

        function enableAudio() {
            if (!audioInitialized && audioContext) {
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        audioInitialized = true;
                        console.log('ğŸ”Š ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª - Ù„Ø¹Ø¨Ø© Ø§Ù„ØºØ§Ø¨Ø©');
                        setTimeout(() => playSound('click'), 100);
                    });
                } else {
                    audioInitialized = true;
                    console.log('ğŸ”Š Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª Ø¬Ø§Ù‡Ø² - Ù„Ø¹Ø¨Ø© Ø§Ù„ØºØ§Ø¨Ø©');
                }
            }
        }

        function playSound(type) {
            if (!gameState.soundEnabled || !audioContext) return;

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© AudioContext
            if (audioContext.state === 'suspended') {
                // Ù„Ø§ Ù†Ø­Ø§ÙˆÙ„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ù„Ù‚Ø§Ù‹
                return;
            }

            if (!audioInitialized) {
                return; // Ù„Ø§ Ù†Ø­Ø§ÙˆÙ„ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            }

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                switch(type) {
                    case 'click':
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        oscillator.type = 'sine';
                        break;

                    case 'discover':
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(900, audioContext.currentTime + 0.2);
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.type = 'triangle';
                        break;

                    case 'correct':
                        oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.3);
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.type = 'square';
                        break;

                    case 'wrong':
                        oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + 0.2);
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.type = 'sawtooth';
                        break;

                    case 'levelUp':
                        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.5);
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        oscillator.type = 'sine';
                        break;

                    default:
                        return;
                }

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

            } catch (error) {
                console.log('ğŸ”‡ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª');
            }
        }

        function toggleSound() {
            enableAudio();

            gameState.soundEnabled = !gameState.soundEnabled;
            const soundBtn = document.getElementById('sound-btn');

            if (gameState.soundEnabled) {
                soundBtn.textContent = 'ğŸ”Š Ø§Ù„ØµÙˆØª';
                soundBtn.style.opacity = '1';
                setTimeout(() => playSound('click'), 100);
            } else {
                soundBtn.textContent = 'ğŸ”‡ ØµØ§Ù…Øª';
                soundBtn.style.opacity = '0.6';
            }

            localStorage.setItem('forest-game-sound-enabled', gameState.soundEnabled);
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('coins-count').textContent = gameState.coins;
            document.getElementById('discovered').textContent = gameState.gamesPlayed;
            document.getElementById('correct').textContent = gameState.wins;
            document.getElementById('wrong').textContent = gameState.losses;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('bet-amount').textContent = gameState.betAmount;

            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            document.getElementById('player-gold').textContent = gameState.coins;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            if (window.playerHeader && typeof window.playerHeader.updateBalance === 'function') {
                const currentPearls = parseInt(document.getElementById('player-pearls').textContent) || 0;
                window.playerHeader.updateBalance({
                    gold: gameState.coins,
                    pearls: currentPearls,
                    balance: gameState.coins
                });
                console.log('ğŸ’° ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù‡ÙŠØ¯Ø±:', { gold: gameState.coins, pearls: currentPearls });
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ù‚ÙØ§Øµ
        function createCages() {
            const grid = document.getElementById('cages-grid');
            grid.innerHTML = '';

            for (let i = 0; i < 9; i++) {
                const cage = document.createElement('div');
                cage.className = 'cage';
                cage.dataset.index = i;
                cage.onclick = () => openCage(i);

                cage.innerHTML = `
                    <div class="cage-number">${i + 1}</div>
                    <img class="cage-cover" src="/images/OIP.jpg" alt="ØµÙ†Ø¯ÙˆÙ‚" onerror="this.style.display='none'; this.parentNode.innerHTML += 'ğŸ“¦';">
                    <div class="cage-content">
                        <img class="revealed-image" src="" alt="">
                        <div class="revealed-name"></div>
                        <div class="revealed-result"></div>
                    </div>
                `;

                grid.appendChild(cage);
            }
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¯Ù Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        function selectRandomTarget() {
            const randomAnimal = animals[Math.floor(Math.random() * animals.length)];
            gameState.targetAnimal = randomAnimal;

            // Ø¹Ø±Ø¶ Ø§Ù„Ù‡Ø¯Ù
            document.getElementById('target-image').src = `/images/${randomAnimal.image}`;
            document.getElementById('target-image').onerror = function() {
                this.src = '/images/default-avatar.png';
            };
            document.getElementById('target-name').textContent = randomAnimal.name;
            document.getElementById('target-reward').textContent = `+${randomAnimal.points} Ø¹Ù…Ù„Ø©`;

            document.getElementById('target-animal').style.display = 'block';
            document.getElementById('start-message').style.display = 'none';
        }

        // Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚ÙØ§Øµ Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        function fillCages() {
            gameState.cageContents = [];

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Ù‚ÙØµ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
            const targetPosition = Math.floor(Math.random() * 9);

            // Ø¥Ø¶Ø§ÙØ© 1-2 ÙˆØ­ÙˆØ´ ÙÙŠ Ù…ÙˆØ§Ù‚Ø¹ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            const numMonsters = Math.random() < 0.7 ? 1 : 2; // 70% Ø§Ø­ØªÙ…Ø§Ù„ ÙˆØ­Ø´ ÙˆØ§Ø­Ø¯ØŒ 30% ÙˆØ­Ø´ÙŠÙ†
            const monsterPositions = [];

            for (let m = 0; m < numMonsters; m++) {
                let monsterPosition;
                do {
                    monsterPosition = Math.floor(Math.random() * 9);
                } while (monsterPosition === targetPosition || monsterPositions.includes(monsterPosition));
                monsterPositions.push(monsterPosition);
            }

            // Ù…Ù„Ø¡ Ø§Ù„Ø£Ù‚ÙØ§Øµ
            for (let i = 0; i < 9; i++) {
                if (i === targetPosition) {
                    // Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                    gameState.cageContents[i] = { ...gameState.targetAnimal, isTarget: true };
                } else if (monsterPositions.includes(i)) {
                    // ÙˆØ­Ø´ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                    const randomMonster = monsters[Math.floor(Math.random() * monsters.length)];
                    gameState.cageContents[i] = { ...randomMonster, isTarget: false };
                } else {
                    // Ø­ÙŠÙˆØ§Ù† Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø¢Ø®Ø±
                    const randomAnimal = animals[Math.floor(Math.random() * animals.length)];
                    gameState.cageContents[i] = { ...randomAnimal, isTarget: false };
                }
            }
        }

        // ÙØªØ­ Ù‚ÙØµ
        async function openCage(index) {
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            enableAudio();

            if (!gameState.isPlaying) {
                // Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                const canStart = await startNewRound();
                if (!canStart) {
                    return;
                }
                gameState.isPlaying = true;
            }

            const cage = document.querySelector(`[data-index="${index}"]`);
            if (cage.classList.contains('opened')) {
                return; // Ø§Ù„Ù‚ÙØµ Ù…ÙØªÙˆØ­ Ø¨Ø§Ù„ÙØ¹Ù„
            }

            // ØªØ¹Ø·ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚ÙØ§Øµ
            document.querySelectorAll('.cage').forEach(c => c.classList.add('disabled'));

            const content = gameState.cageContents[index];

            // ØªØ£Ø«ÙŠØ± ÙØªØ­ Ø§Ù„Ù‚ÙØµ
            cage.classList.add('opening');

            // ÙØªØ­ Ø§Ù„Ù‚ÙØµ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø«ÙŠØ±
            setTimeout(() => {
                cage.classList.remove('opening');
                cage.classList.add('opened');
            }, 250);

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
            const image = cage.querySelector('.revealed-image');
            const name = cage.querySelector('.revealed-name');
            const result = cage.querySelector('.revealed-result');

            image.src = `/images/${content.image}`;
            image.onerror = function() {
                this.src = '/images/default-avatar.png';
            };
            name.textContent = content.name;

            let resultText = '';
            let resultClass = '';
            let coinChange = 0;

            if (content.type === 'monster') {
                // ÙˆØ­Ø´ - Ø®Ø³Ø§Ø±Ø©
                resultText = `Ø®Ø³Ø§Ø±Ø©: -${gameState.betAmount}`;
                resultClass = 'result-lose';
                coinChange = -gameState.betAmount;
                gameState.losses++;
                playSound('wrong');
                showMessage(`ğŸ’€ ÙˆØ­Ø´! Ø®Ø³Ø±Øª ${gameState.betAmount} Ø¹Ù…Ù„Ø©`, 'error');
            } else if (content.isTarget) {
                // Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ - ÙÙˆØ² ÙƒØ¨ÙŠØ±
                if (content.type === 'multiplier') {
                    coinChange = gameState.betAmount * content.multiplier;
                    resultText = `ğŸ¯ Ø§Ù„Ù‡Ø¯Ù! x${content.multiplier}`;
                    resultClass = 'result-target';
                    playSound('levelUp');
                    showMessage(`ğŸ¯ Ù…Ù…ØªØ§Ø²! ÙˆØ¬Ø¯Øª Ø§Ù„Ù‡Ø¯Ù! Ù…Ø¶Ø§Ø¹Ù x${content.multiplier}! +${coinChange} Ø¹Ù…Ù„Ø©`, 'success');
                } else if (content.type === 'refund') {
                    coinChange = gameState.betAmount;
                    resultText = `ğŸ¯ Ø§Ù„Ù‡Ø¯Ù! Ø§Ø³ØªØ±Ø¯Ø§Ø¯`;
                    resultClass = 'result-target';
                    playSound('levelUp');
                    showMessage(`ğŸ¯ Ù…Ù…ØªØ§Ø²! ÙˆØ¬Ø¯Øª Ø§Ù„Ù‡Ø¯Ù! ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ${coinChange} Ø¹Ù…Ù„Ø©`, 'success');
                } else if (content.type === 'double_loss') {
                    coinChange = -gameState.betAmount;
                    resultText = `ğŸ¯ Ø§Ù„Ù‡Ø¯Ù! Ø®Ø³Ø§Ø±Ø© Ù…Ø¶Ø§Ø¹ÙØ©`;
                    resultClass = 'result-double-loss';
                    playSound('wrong');
                    showMessage(`ğŸ¯ ÙˆØ¬Ø¯Øª Ø§Ù„Ù‡Ø¯Ù Ù„ÙƒÙ†Ù‡ Ø®Ø·ÙŠØ±! Ø®Ø³Ø±Øª ${Math.abs(coinChange)} Ø¹Ù…Ù„Ø©`, 'error');
                } else {
                    coinChange = content.points;
                    resultText = `ğŸ¯ Ø§Ù„Ù‡Ø¯Ù! +${content.points}`;
                    resultClass = 'result-target';
                    playSound('levelUp');
                    showMessage(`ğŸ¯ Ù…Ù…ØªØ§Ø²! ÙˆØ¬Ø¯Øª Ø§Ù„Ù‡Ø¯Ù! +${content.points} Ø¹Ù…Ù„Ø©`, 'success');
                }
                gameState.wins++;
            } else {
                // Ø­ÙŠÙˆØ§Ù† Ø¢Ø®Ø± - ØªØ£Ø«ÙŠØ±Ø§Øª Ù…Ø®ØªÙ„ÙØ©
                if (content.type === 'multiplier') {
                    coinChange = gameState.betAmount * content.multiplier;
                    resultText = `Ù…Ø¶Ø§Ø¹Ù x${content.multiplier}!`;
                    resultClass = 'result-multiplier';
                    playSound('levelUp');
                    showMessage(`ğŸ‰ Ù…Ø¶Ø§Ø¹Ù Ø±Ø§Ø¦Ø¹! x${content.multiplier}! +${coinChange} Ø¹Ù…Ù„Ø©`, 'success');
                } else if (content.type === 'refund') {
                    coinChange = gameState.betAmount;
                    resultText = `Ø§Ø³ØªØ±Ø¯Ø§Ø¯`;
                    resultClass = 'result-win';
                    playSound('correct');
                    showMessage(`ğŸ’° ØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬ÙˆÙ„Ø©: +${coinChange} Ø¹Ù…Ù„Ø©`, 'info');
                } else if (content.type === 'double_loss') {
                    coinChange = -gameState.betAmount * 2;
                    resultText = `Ø®Ø³Ø§Ø±Ø© Ù…Ø¶Ø§Ø¹ÙØ©!`;
                    resultClass = 'result-double-loss';
                    playSound('wrong');
                    showMessage(`ğŸ’¸ Ø®Ø³Ø§Ø±Ø© Ù…Ø¶Ø§Ø¹ÙØ©! Ø®Ø³Ø±Øª ${Math.abs(coinChange)} Ø¹Ù…Ù„Ø©`, 'error');
                } else {
                    coinChange = content.points;
                    resultText = `+${content.points}`;
                    resultClass = 'result-win';
                    playSound('correct');
                    showMessage(`âœ… Ø­ÙŠÙˆØ§Ù† Ø¬Ù…ÙŠÙ„! +${content.points} Ø¹Ù…Ù„Ø©`, 'success');
                }
                gameState.wins++;
            }

            result.textContent = resultText;
            result.className = `revealed-result ${resultClass}`;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ø§Ø·
            gameState.coins += coinChange;
            gameState.score += Math.max(0, coinChange);
            gameState.gamesPlayed++;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
            await updateEconomyBalance(coinChange);

            updateDisplay();
            saveGameData();

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù‚ÙØ§Øµ Ø¨Ø¹Ø¯ 2.5 Ø«Ø§Ù†ÙŠØ©
            setTimeout(() => {
                resetCagesForNextRound();
            }, 2500);
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
        async function refreshPlayerData() {
            console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨...');
            await loadPlayerData();
            updateDisplay();
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø®Ù„Ù
        function goBack() {
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±
            enableAudio();
            playSound('click');

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©
            if (gameState.isPlaying && gameState.gamesPlayed > 0) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ù„Ø¹Ø¨Ø©ØŒ Ø·Ù„Ø¨ Ø§Ù„ØªØ£ÙƒÙŠØ¯
                const confirmExit = confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ØªÙÙ‚Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©.');
                if (!confirmExit) {
                    return; // Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø®Ø±ÙˆØ¬
                }
            }

            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬
            saveGameData();

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            if (document.referrer &&
                document.referrer !== window.location.href &&
                !document.referrer.includes('forest-game.html')) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØµÙØ­Ø© Ø³Ø§Ø¨Ù‚Ø© ØµØ­ÙŠØ­Ø©ØŒ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„ÙŠÙ‡Ø§
                window.history.back();
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù‡Ù†Ø§Ùƒ ØµÙØ­Ø© Ø³Ø§Ø¨Ù‚Ø© ØµØ­ÙŠØ­Ø©ØŒ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                window.location.href = '/';
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù‚ÙØ§Øµ Ù„Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        function resetCagesForNextRound() {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù‚ÙØ§Øµ
            document.querySelectorAll('.cage').forEach(cage => {
                cage.classList.remove('opened', 'disabled');
            });

            // Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯ ÙˆÙ…Ù„Ø¡ Ø§Ù„Ø£Ù‚ÙØ§Øµ
            selectRandomTarget();
            fillCages();

            // ÙØ­Øµ Ø§Ù„Ø§Ø±ØªÙ‚Ø§Ø¡ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ
            if (gameState.wins >= gameState.level * 3) {
                gameState.level++;
                gameState.betAmount += 10; // Ø²ÙŠØ§Ø¯Ø© ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬ÙˆÙ„Ø©
                playSound('levelUp');
                showMessage(`ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${gameState.level}!`, 'success');
                updateDisplay();
            }

            showMessage('ğŸ”„ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©! Ø§Ø®ØªØ± ØµÙ†Ø¯ÙˆÙ‚Ø§Ù‹ Ø¢Ø®Ø±', 'info');
        }

        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function endGame() {
            gameState.isPlaying = false;

            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù‚ÙØ§Øµ
            document.querySelectorAll('.cage').forEach(cage => {
                cage.classList.remove('opened', 'disabled');
            });

            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‡Ø¯Ù
            document.getElementById('target-animal').style.display = 'none';
            document.getElementById('start-message').style.display = 'block';
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
        async function initializeEconomy() {
            try {
                if (window.gameEconomy && typeof window.gameEconomy.initializeGameSession === 'function') {
                    gameState.economySession = await window.gameEconomy.initializeGameSession('forest-game', gameState.betAmount);
                    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„ØºØ§Ø¨Ø©');
                } else {
                    console.log('ğŸ® ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨');
                }
            } catch (error) {
                console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        async function loadPlayerData() {
            try {
                console.log('ğŸ”„ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨...');

                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±
                if (window.playerHeader) {
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù‡ÙŠØ¯Ø±
                    const playerName = window.playerHeader.username || 'Ø§Ù„Ù„Ø§Ø¹Ø¨';
                    const playerBalance = window.playerHeader.balance || gameState.coins;
                    const playerId = window.playerHeader.playerId || '';
                    const playerAvatar = window.playerHeader.avatar || '/images/default-avatar.png';

                    console.log('ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±:', {
                        username: playerName,
                        balance: playerBalance,
                        playerId: playerId,
                        avatar: playerAvatar
                    });

                    // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                    document.getElementById('player-name').textContent = playerName;
                    document.getElementById('player-level').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1`; // ÙŠÙ…ÙƒÙ† ØªØ­Ø³ÙŠÙ†Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹

                    // ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨
                    if (playerAvatar && playerAvatar !== '/images/default-avatar.png') {
                        document.getElementById('player-avatar').src = playerAvatar;
                        document.getElementById('player-avatar').onerror = function() {
                            this.src = '/images/default-avatar.png';
                        };
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                    if (typeof playerBalance === 'number' && playerBalance > 0) {
                        gameState.coins = playerBalance;
                        document.getElementById('player-gold').textContent = playerBalance;
                        console.log('ğŸ’° ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±:', playerBalance);
                    } else {
                        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
                        if (window.gameEconomy && typeof window.gameEconomy.getPlayerBalance === 'function') {
                            try {
                                const economyBalance = await window.gameEconomy.getPlayerBalance();
                                if (economyBalance && economyBalance.gold) {
                                    gameState.coins = economyBalance.gold;
                                    document.getElementById('player-gold').textContent = economyBalance.gold;
                                    document.getElementById('player-pearls').textContent = economyBalance.pearls || 0;
                                    console.log('ğŸ’° ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ:', economyBalance);
                                } else {
                                    document.getElementById('player-gold').textContent = gameState.coins;
                                    document.getElementById('player-pearls').textContent = 0;
                                }
                            } catch (economyError) {
                                console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ:', economyError);
                                document.getElementById('player-gold').textContent = gameState.coins;
                                document.getElementById('player-pearls').textContent = 0;
                            }
                        } else {
                            document.getElementById('player-gold').textContent = gameState.coins;
                            document.getElementById('player-pearls').textContent = 0;
                        }
                    }

                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† localStorage
                    const userData = localStorage.getItem('userData');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            if (user.level) {
                                document.getElementById('player-level').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${user.level}`;
                            }
                            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ù† localStorage:', user);
                        } catch (parseError) {
                            console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª localStorage:', parseError);
                        }
                    }

                    // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
                    document.getElementById('player-info').style.display = 'flex';
                    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù†Ø¬Ø§Ø­');

                } else {
                    console.log('âŒ window.playerHeader ØºÙŠØ± Ù…ØªØ§Ø­');
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
                    const userData = localStorage.getItem('userData');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            document.getElementById('player-name').textContent = user.username || 'Ø§Ù„Ù„Ø§Ø¹Ø¨';
                            document.getElementById('player-level').textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${user.level || 1}`;
                            if (user.profilePicture || user.avatar) {
                                document.getElementById('player-avatar').src = user.profilePicture || user.avatar;
                            }
                            if (user.balance || user.coins) {
                                gameState.coins = user.balance || user.coins;
                                document.getElementById('player-gold').textContent = gameState.coins;
                            } else {
                                document.getElementById('player-gold').textContent = gameState.coins;
                            }
                            document.getElementById('player-pearls').textContent = user.pearls || 0;
                            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage:', user);
                        } catch (parseError) {
                            console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª localStorage:', parseError);
                            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                            document.getElementById('player-name').textContent = 'Ø§Ù„Ù„Ø§Ø¹Ø¨';
                            document.getElementById('player-level').textContent = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1';
                            document.getElementById('player-gold').textContent = gameState.coins;
                            document.getElementById('player-pearls').textContent = 0;
                        }
                    } else {
                        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                        document.getElementById('player-name').textContent = 'Ø§Ù„Ù„Ø§Ø¹Ø¨';
                        document.getElementById('player-level').textContent = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1';
                        document.getElementById('player-gold').textContent = gameState.coins;
                        document.getElementById('player-pearls').textContent = 0;
                    }
                    document.getElementById('player-info').style.display = 'flex';
                }

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨:', error);
                // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
                document.getElementById('player-name').textContent = 'Ø§Ù„Ù„Ø§Ø¹Ø¨';
                document.getElementById('player-level').textContent = 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 1';
                document.getElementById('player-gold').textContent = gameState.coins;
                document.getElementById('player-pearls').textContent = 0;
                document.getElementById('player-info').style.display = 'flex';
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        function loadGameData() {
            try {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
                const savedData = localStorage.getItem('forest-game-data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    gameState.score = data.score || 0;
                    gameState.gamesPlayed = data.gamesPlayed || 0;
                    gameState.wins = data.wins || 0;
                    gameState.losses = data.losses || 0;
                    gameState.level = data.level || 1;
                    gameState.betAmount = data.betAmount || 50;
                }

                // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª
                const soundSetting = localStorage.getItem('forest-game-sound-enabled');
                if (soundSetting !== null) {
                    gameState.soundEnabled = soundSetting === 'true';
                }
            } catch (error) {
                console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        function saveGameData() {
            try {
                const dataToSave = {
                    score: gameState.score,
                    gamesPlayed: gameState.gamesPlayed,
                    wins: gameState.wins,
                    losses: gameState.losses,
                    level: gameState.level,
                    betAmount: gameState.betAmount
                };
                localStorage.setItem('forest-game-data', JSON.stringify(dataToSave));
            } catch (error) {
                console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            }
        }

        // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø¨ÙƒØ© Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª
        function createAnimalsGrid() {
            const grid = document.getElementById('animals-grid');
            grid.innerHTML = '';

            // Ø§Ø®ØªÙŠØ§Ø± Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
            const animalsToShow = getAnimalsForLevel(gameState.level);

            animalsToShow.forEach((animal, index) => {
                const card = document.createElement('div');
                card.className = 'animal-card';
                card.onclick = () => discoverAnimal(animal);

                card.innerHTML = `
                    <img src="/images/${animal.image}" alt="${animal.name}" class="animal-image"
                         onerror="this.src='/images/default-avatar.png'">
                    <div class="animal-name">â“</div>
                    <div class="animal-points">+${animal.points}</div>
                `;

                grid.appendChild(card);
            });
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        function getAnimalsForLevel(level) {
            const animalsPerLevel = Math.min(6 + level, 12);
            const shuffled = [...animals].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, animalsPerLevel);
        }

        // Ø§ÙƒØªØ´Ø§Ù Ø­ÙŠÙˆØ§Ù†
        async function discoverAnimal(animal) {
            if (!gameState.isPlaying) {
                showMessage('Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹!', 'error');
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Øª
            if (gameState.coins < gameState.discoveryCost) {
                showMessage('ğŸ’° Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø¹Ù…Ù„Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø­ÙŠÙˆØ§Ù†!', 'error');
                return;
            }

            // Ø®ØµÙ… ØªÙƒÙ„ÙØ© Ø§Ù„Ø§ÙƒØªØ´Ø§Ù
            gameState.coins -= gameState.discoveryCost;
            gameState.discovered++;

            playSound('discover');

            // Ø¹Ø±Ø¶ Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø­ÙŠÙˆØ§Ù†
            const isCorrect = await askAnimalQuestion(animal);

            if (isCorrect) {
                gameState.correct++;
                gameState.score += animal.points;
                gameState.coins += animal.points;

                playSound('correct');
                showMessage(`âœ… ØµØ­ÙŠØ­! +${animal.points} Ù†Ù‚Ø·Ø© Ùˆ +${animal.points} Ø¹Ù…Ù„Ø©`, 'success');

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
                updateEconomyBalance(animal.points);
            } else {
                gameState.wrong++;
                playSound('wrong');
                showMessage(`âŒ Ø®Ø·Ø£! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${animal.name}`, 'error');
            }

            // ÙØ­Øµ Ø§Ù„Ø§Ø±ØªÙ‚Ø§Ø¡ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ
            checkLevelUp();

            updateDisplay();
            saveGameData();
        }

        // Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø­ÙŠÙˆØ§Ù†
        function askAnimalQuestion(animal) {
            return new Promise((resolve) => {
                const options = generateAnimalOptions(animal);
                const question = `ğŸ¾ Ù…Ø§ Ø§Ø³Ù… Ù‡Ø°Ø§ Ø§Ù„Ø­ÙŠÙˆØ§Ù†ØŸ`;

                let optionsText = '';
                options.forEach((option, index) => {
                    optionsText += `${index + 1}. ${option}\n`;
                });

                const userAnswer = prompt(`${question}\n\n${optionsText}\nØ£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (1-4):`);

                if (userAnswer && parseInt(userAnswer) === options.indexOf(animal.name) + 1) {
                    resolve(true);
                } else {
                    resolve(false);
                }
            });
        }

        // ØªÙˆÙ„ÙŠØ¯ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        function generateAnimalOptions(correctAnimal) {
            const options = [correctAnimal.name];
            const otherAnimals = animals.filter(a => a.name !== correctAnimal.name);

            // Ø¥Ø¶Ø§ÙØ© 3 Ø®ÙŠØ§Ø±Ø§Øª Ø®Ø§Ø·Ø¦Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            while (options.length < 4) {
                const randomAnimal = otherAnimals[Math.floor(Math.random() * otherAnimals.length)];
                if (!options.includes(randomAnimal.name)) {
                    options.push(randomAnimal.name);
                }
            }

            // Ø®Ù„Ø· Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            return options.sort(() => Math.random() - 0.5);
        }

        // ÙØ­Øµ Ø§Ù„Ø§Ø±ØªÙ‚Ø§Ø¡ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ
        function checkLevelUp() {
            const requiredCorrect = gameState.level * 5;
            if (gameState.correct >= requiredCorrect) {
                gameState.level++;
                playSound('levelUp');
                showMessage(`ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${gameState.level}!`, 'success');

                // Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø¨ÙƒØ© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                createAnimalsGrid();
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
        async function updateEconomyBalance(coinChange) {
            try {
                // ØªØ®Ø·ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Øª
                if (coinChange === 0) return;

                console.log('ğŸ’° ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯:', coinChange);

                if (window.gameEconomy && typeof window.gameEconomy.updatePlayerBalance === 'function') {
                    const gameResult = {
                        isWin: coinChange > 0,
                        winAmount: Math.max(0, coinChange),
                        lossAmount: Math.abs(Math.min(0, coinChange)),
                        totalWin: Math.max(0, coinChange),
                        totalBet: gameState.betAmount,
                        gameType: 'forest-game'
                    };

                    const balanceUpdate = await window.gameEconomy.updatePlayerBalance(gameResult);
                    if (balanceUpdate && balanceUpdate.success) {
                        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ Ø¨Ù†Ø¬Ø§Ø­:', balanceUpdate);

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ù„ÙŠ
                        if (balanceUpdate.newBalance && typeof balanceUpdate.newBalance.gold === 'number') {
                            gameState.coins = balanceUpdate.newBalance.gold;
                        }

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‡ÙŠØ¯Ø±
                        if (window.playerHeader && typeof window.playerHeader.updateBalance === 'function') {
                            window.playerHeader.updateBalance(balanceUpdate.newBalance);
                        }

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
                        updateDisplay();
                    } else {
                        console.log('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ:', balanceUpdate);
                    }
                } else {
                    console.log('âš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ ØºÙŠØ± Ù…ØªØ§Ø­');
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ:', error);
                // Ù„Ø§ Ù†ÙˆÙ‚Ù Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function startGame() {
            // Ù„Ø§ Ù†Ø´ØºÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ØªØµÙØ­
            gameState.isPlaying = true;
            selectRandomTarget();
            fillCages();

            showMessage(`ğŸŒ² Ø§Ø¨Ø­Ø« Ø¹Ù† ${gameState.targetAnimal.name} ÙÙŠ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚!`, 'info');
            updateDisplay();
        }

        // Ø¨Ø¯Ø¡ Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©
        async function startNewRound() {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
                if (window.gameEconomy && typeof window.gameEconomy.canPlay === 'function') {
                    const canPlayCheck = window.gameEconomy.canPlay(gameState.betAmount);
                    if (!canPlayCheck.canPlay) {
                        showMessage(canPlayCheck.reason || 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©', 'error');
                        endGame();
                        return false;
                    }
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Øª
                if (gameState.coins < gameState.betAmount) {
                    showMessage(`ğŸ’° ØªØ­ØªØ§Ø¬ ${gameState.betAmount} Ø¹Ù…Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©!`, 'error');
                    endGame();
                    return false;
                }

                // Ø®ØµÙ… ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬ÙˆÙ„Ø©
                gameState.coins -= gameState.betAmount;
                updateDisplay();

                return true;
            } catch (error) {
                console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©:', error);
                return false;
            }
        }

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©
        function resetGame() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©ØŸ Ø³ØªÙÙ‚Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø¯Ù…!')) {
                gameState.score = 0;
                gameState.gamesPlayed = 0;
                gameState.wins = 0;
                gameState.losses = 0;
                gameState.level = 1;
                gameState.betAmount = 50;
                gameState.isPlaying = false;

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø£Ù‚ÙØ§Øµ
                document.querySelectorAll('.cage').forEach(cage => {
                    cage.classList.remove('opened', 'disabled');
                });

                // Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©
                startGame();

                updateDisplay();
                saveGameData();

                showMessage('ğŸ”„ ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø©!', 'info');
                playSound('click');
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø®Ù„Ù ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­
        window.addEventListener('beforeunload', function(e) {
            if (gameState.isPlaying && gameState.gamesPlayed > 0) {
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬
                saveGameData();

                // Ø±Ø³Ø§Ù„Ø© ØªØ­Ø°ÙŠØ±ÙŠØ© (Ù‚Ø¯ Ù„Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª)
                const message = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ØªÙÙ‚Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©.';
                e.returnValue = message;
                return message;
            }
        });

        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø²Ø± Ø§Ù„Ø®Ù„Ù)
        window.addEventListener('popstate', function(e) {
            if (gameState.isPlaying && gameState.gamesPlayed > 0) {
                const confirmExit = confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ Ø³ØªÙÙ‚Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ù„Ø¹Ø¨Ø©.');
                if (!confirmExit) {
                    // Ù…Ù†Ø¹ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ§Ø±ÙŠØ®
                    history.pushState(null, null, window.location.href);
                    return;
                }
            }
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø±ÙˆØ¬
            saveGameData();
        });

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ù„Ù„ØªØ§Ø±ÙŠØ® Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø²Ø± Ø§Ù„Ø®Ù„Ù
                history.pushState(null, null, window.location.href);

                // ØªÙ‡ÙŠØ¦Ø© Ù‡ÙŠØ¯Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹
                if (window.playerHeader && typeof window.playerHeader.init === 'function') {
                    await window.playerHeader.init();
                    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‡ÙŠØ¯Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨');
                } else {
                    console.log('âš ï¸ Ù‡ÙŠØ¯Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ ØºÙŠØ± Ù…ØªØ§Ø­');
                }

                initAudio();
                loadPlayerData();
                loadGameData();
                await initializeEconomy();
                createCages();
                startGame(); // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                updateDisplay();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©:', error);
                // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„Øª Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
                initAudio();
                loadGameData();
                createCages();
                startGame();
                updateDisplay();
            }
        });
    </script>
</body>
</html>
