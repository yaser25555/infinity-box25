<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üå≤ ŸÑÿπÿ®ÿ© ÿßŸÑÿ∫ÿßÿ®ÿ© - ÿßŸÉÿ™ÿ¥ŸÅ ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2d5016, #4a7c59, #2d5016);
            color: white;
            min-height: 100vh;
            padding: 10px;
        }

        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .back-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 12px;
            width: 45px;
            height: 40px;
            color: white;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.5);
            background: linear-gradient(135deg, #ff5252, #e53935);
        }

        .back-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .game-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .score-display {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a202c;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        /* Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿπŸÖŸÑÿßÿ™ */
        .coins-display {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .coin-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }

        .coin-icon {
            font-size: 1.5em;
        }

        #coins-count {
            color: #ffd700;
            font-size: 1.3em;
        }

        .game-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 0.9em;
            color: #cbd5e0;
        }

        /* ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® */
        .player-info {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-avatar {
            flex-shrink: 0;
        }

        .player-details {
            flex: 1;
        }

        .player-balance {
            display: flex;
            flex-direction: column;
            gap: 5px;
            text-align: right;
        }

        /* ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ© */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #cbd5e0;
        }

        /* ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÑÿπÿ® */
        .game-area {
            background: linear-gradient(135deg, #1a4d2e, #2d5016);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
            position: relative;
            border: 3px solid rgba(255, 215, 0, 0.3);
        }

        /* ŸáÿØŸÅ ÿßŸÑÿ®ÿ≠ÿ´ */
        .target-animal {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .target-animal h3 {
            color: #ffd700;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .target-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .target-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #ffd700;
        }

        .target-details {
            color: #e2e8f0;
        }

        .target-reward {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: bold;
        }

        /* ÿ¥ÿ®ŸÉÿ© ÿßŸÑÿ£ŸÇŸÅÿßÿµ */
        .cages-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            max-width: 100%;
            padding: 0 10px;
        }

        .cage {
            background: linear-gradient(135deg, #8B4513, #CD853F, #DEB887);
            border: 3px solid #654321;
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .cage:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4);
            border-color: #ffd700;
        }

        .cage.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .cage-cover {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 5px;
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.5));
        }

        .cage-number {
            position: absolute;
            top: 3px;
            left: 3px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a202c;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            font-weight: bold;
            border: 2px solid #654321;
        }

        .cage-content {
            display: none;
        }

        .cage.opened .cage-cover {
            display: none;
        }

        .cage.opened .cage-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ± ŸÅÿ™ÿ≠ ÿßŸÑŸÇŸÅÿµ */
        .cage.opening .cage-cover {
            animation: cageOpen 0.5s ease-out forwards;
        }

        @keyframes cageOpen {
            0% {
                transform: scale(1) rotateY(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.1) rotateY(90deg);
                opacity: 0.5;
            }
            100% {
                transform: scale(0) rotateY(180deg);
                opacity: 0;
                display: none;
            }
        }

        .revealed-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ffd700;
        }

        .revealed-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 0.7em;
            margin: 2px 0;
        }

        .revealed-result {
            padding: 3px 6px;
            border-radius: 6px;
            font-size: 0.6em;
            font-weight: bold;
            margin-top: 2px;
        }

        .result-win {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .result-lose {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .result-target {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a202c;
        }

        .result-multiplier {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            animation: glow 1s ease-in-out infinite alternate;
        }

        .result-double-loss {
            background: linear-gradient(135deg, #dc2626, #991b1b);
            color: white;
        }

        /* ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ */
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑŸÑÿπÿ®ÿ© */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .message.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .message.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .message.info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿ¨ŸàÿßŸÑ */
        @media (max-width: 768px) {
            .game-container {
                margin: 2px;
                padding: 5px;
                max-width: 100vw;
                box-sizing: border-box;
            }

            .header {
                margin-bottom: 5px;
                padding: 4px 6px;
                flex-wrap: wrap;
            }

            .game-title {
                font-size: 0.9em;
                order: 1;
                flex: 1;
                text-align: center;
            }

            .back-btn {
                width: 35px;
                height: 32px;
                font-size: 1.1em;
                order: 0;
                border-radius: 8px;
            }

            .coins-display {
                padding: 6px;
                margin: 5px 0;
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }

            .coin-counter {
                font-size: 1em;
            }

            .game-info {
                font-size: 0.7em;
            }

            .player-info {
                padding: 8px;
                margin: 8px 0;
                gap: 8px;
            }

            .player-info img {
                width: 35px !important;
                height: 35px !important;
            }

            .player-details {
                font-size: 0.8em;
            }

            .player-balance {
                font-size: 0.8em;
                gap: 3px;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 5px;
                margin: 5px 0;
            }

            .stat-item {
                padding: 6px;
            }

            .stat-value {
                font-size: 1em;
            }

            .stat-label {
                font-size: 0.7em;
            }

            .game-area {
                padding: 10px;
                margin: 5px 0;
                min-height: 300px;
            }

            .target-animal {
                padding: 10px;
                margin-bottom: 10px;
            }

            .target-animal h3 {
                font-size: 1em;
                margin-bottom: 8px;
            }

            .target-image {
                width: 40px;
                height: 40px;
            }

            .target-details {
                font-size: 0.8em;
            }

            .target-reward {
                padding: 4px 8px;
                font-size: 0.7em;
            }

            .cages-grid {
                gap: 5px;
                margin: 10px 0;
                padding: 0 5px;
            }

            .cage {
                min-height: 60px;
                padding: 5px;
                border-radius: 8px;
            }

            .cage-cover {
                width: 35px;
                height: 35px;
                margin-bottom: 2px;
            }

            .cage-number {
                width: 16px;
                height: 16px;
                font-size: 0.6em;
                top: 2px;
                left: 2px;
            }

            .revealed-image {
                width: 30px;
                height: 30px;
            }

            .revealed-name {
                font-size: 0.6em;
            }

            .revealed-result {
                font-size: 0.5em;
                padding: 2px 4px;
            }

            .controls {
                gap: 5px;
                margin: 5px 0;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 0.7em;
                flex: 1;
                min-width: 80px;
            }

            #start-message {
                font-size: 0.9em;
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ÿßŸÑŸáŸäÿØÿ± -->
        <div class="header">
            <button class="back-btn" onclick="goBack()" title="ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©">‚Üê</button>
            <h1 class="game-title">üå≤ ŸÑÿπÿ®ÿ© ÿßŸÑÿ∫ÿßÿ®ÿ©</h1>
            <div class="score-display">
                ÿßŸÑŸÜŸÇÿßÿ∑: <span id="score">0</span>
            </div>
        </div>

        <!-- Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑÿπŸÖŸÑÿßÿ™ -->
        <div class="coins-display">
            <div class="coin-counter">
                <span class="coin-icon">üí∞</span>
                <span id="coins-count">1000</span>
                <span class="coin-label">ÿπŸÖŸÑÿ©</span>
            </div>
            <div class="game-info">
                <span>üéØ ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ¨ŸàŸÑÿ©: <span id="bet-amount">50</span> ÿπŸÖŸÑÿ©</span>
                <span>üèÜ ŸÖŸÉÿßŸÅÿ¢ÿ™: ÿπÿßÿØŸäÿ©ÿå ŸÖÿ∂ÿßÿπŸÅ x5/x8/x10ÿå ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ</span>
                <span>üíÄ ŸÖÿÆÿßÿ∑ÿ±: Ÿàÿ≠Ÿàÿ¥ÿå ÿÆÿ≥ÿßÿ±ÿ© ŸÖÿ∂ÿßÿπŸÅÿ©</span>
            </div>
        </div>

        <!-- ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® -->
        <div class="player-info" id="player-info" style="display: none;">
            <div class="player-avatar">
                <img id="player-avatar" src="/images/default-avatar.png" alt="ÿµŸàÿ±ÿ© ÿßŸÑŸÑÿßÿπÿ®"
                     style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ffd700;">
            </div>
            <div class="player-details">
                <div id="player-name" style="font-weight: bold; color: #ffd700;">ÿßŸÑŸÑÿßÿπÿ®</div>
                <div id="player-level" style="color: #cbd5e0; font-size: 0.9em;">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1</div>
            </div>
            <div class="player-balance">
                <div style="color: #10b981; font-weight: bold;">
                    üí∞ <span id="player-gold">0</span>
                </div>
                <div style="color: #3b82f6; font-weight: bold;">
                    üíé <span id="player-pearls">0</span>
                </div>
            </div>
        </div>

        <!-- ÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ© -->
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="discovered">0</div>
                <div class="stat-label">ÿ¨ŸàŸÑÿßÿ™</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="correct">0</div>
                <div class="stat-label">ŸÅŸàÿ≤</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="wrong">0</div>
                <div class="stat-label">ÿÆÿ≥ÿßÿ±ÿ©</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="level">1</div>
                <div class="stat-label">ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ</div>
            </div>
        </div>

        <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑŸÑÿπÿ® -->
        <div class="game-area">
            <!-- ŸáÿØŸÅ ÿßŸÑÿ®ÿ≠ÿ´ -->
            <div class="target-animal" id="target-animal" style="display: none;">
                <h3>üéØ ÿßÿ®ÿ≠ÿ´ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ≠ŸäŸàÿßŸÜ:</h3>
                <div class="target-info">
                    <img id="target-image" class="target-image" src="" alt="">
                    <div class="target-details">
                        <div id="target-name" style="font-size: 1.2em; font-weight: bold; color: #ffd700;"></div>
                        <div style="margin: 5px 0;">ÿ•ÿ∞ÿß Ÿàÿ¨ÿØÿ™Ÿá:</div>
                        <div class="target-reward" id="target-reward">+0 ÿπŸÖŸÑÿ©</div>
                    </div>
                </div>
            </div>

            <!-- ÿ¥ÿ®ŸÉÿ© ÿßŸÑÿ£ŸÇŸÅÿßÿµ -->
            <div class="cages-grid" id="cages-grid">
                <!-- ÿßŸÑÿ£ŸÇŸÅÿßÿµ ÿ≥ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß -->
            </div>

            <!-- ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ®ÿØÿßŸäÿ© -->
            <div id="start-message" style="text-align: center; color: #ffd700; font-size: 1.2em; display: none;">
                üå≤ ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ÿßŸÑÿ∫ÿßÿ®ÿ©!<br>
                ÿßÿÆÿ™ÿ± ÿµŸÜÿØŸàŸÇÿßŸã ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆŸÅŸäÿ©
            </div>
        </div>

        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ -->
        <div class="controls">
            <button class="control-btn" onclick="enableAudio(); playSound('click'); startGame()">üîÑ ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©</button>
            <button class="control-btn" onclick="enableAudio(); playSound('click'); resetGame()">üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ</button>
            <button class="control-btn" onclick="refreshPlayerData()">üë§ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</button>
            <button class="control-btn" onclick="toggleSound()" id="sound-btn">üîä ÿßŸÑÿµŸàÿ™</button>
        </div>
    </div>

    <script src="/js/player-header.js"></script>
    <script src="/js/game-economy.js"></script>
    <script>
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©
        let gameState = {
            score: 0,
            coins: 1000,
            gamesPlayed: 0,
            wins: 0,
            losses: 0,
            level: 1,
            isPlaying: false,
            targetAnimal: null,
            cageContents: [],
            soundEnabled: true,
            betAmount: 50, // ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ¨ŸàŸÑÿ©
            economySession: null
        };

        // ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ŸÖÿπ ÿßŸÑŸÖÿ∂ÿßÿπŸÅÿßÿ™ ŸàÿßŸÑÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™
        const animals = [
            // ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿπÿßÿØŸäÿ© (ÿ™ÿπÿ∑Ÿä ŸÜŸÇÿßÿ∑ ÿπÿßÿØŸäÿ©)
            { name: 'ŸÉŸÑÿ®', image: 'dog.png', points: 80, type: 'normal', effect: 'normal' },
            { name: 'ŸÇÿ∑ÿ©', image: 'cat.png', points: 70, type: 'normal', effect: 'normal' },
            { name: 'ÿ®ŸÇÿ±ÿ©', image: 'cow.png', points: 90, type: 'normal', effect: 'normal' },
            { name: 'ÿÆÿ±ŸàŸÅ', image: 'sheep.png', points: 85, type: 'normal', effect: 'normal' },
            { name: 'ÿØŸäŸÉ', image: 'rooster.png', points: 60, type: 'normal', effect: 'normal' },
            { name: 'ÿ®ÿ∑ÿ©', image: 'duck.png', points: 65, type: 'normal', effect: 'normal' },
            { name: 'ÿ£ÿ±ŸÜÿ®', image: 'rabbit.png', points: 75, type: 'normal', effect: 'normal' },
            { name: 'ÿ∂ŸÅÿØÿπ', image: 'frog.png', points: 55, type: 'normal', effect: 'normal' },
            { name: 'ÿ≥ŸÖŸÉÿ©', image: 'fish.png', points: 50, type: 'normal', effect: 'normal' },
            { name: 'ÿØÿ¨ÿßÿ¨ÿ©', image: 'chicken.png', points: 55, type: 'normal', effect: 'normal' },
            { name: 'ÿ≠ŸÖÿßÿ±', image: 'donkey.png', points: 70, type: 'normal', effect: 'normal' },
            { name: 'ÿ®ÿ∑ÿ±ŸäŸÇ', image: 'pinguin.png', points: 105, type: 'normal', effect: 'normal' },

            // ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ™ÿπŸäÿØ ŸÇŸäŸÖÿ© ÿßŸÑÿ¨ŸàŸÑÿ© ŸÅŸÇÿ∑
            { name: 'ŸÇÿ±ÿØ', image: 'monkey.png', points: 0, type: 'refund', effect: 'refund' },
            { name: 'ŸÉŸàÿßŸÑÿß', image: 'koala.png', points: 0, type: 'refund', effect: 'refund' },
            { name: 'ÿ±ÿßŸÉŸàŸÜ', image: 'raccoon.png', points: 0, type: 'refund', effect: 'refund' },

            // ÿ≠ŸäŸàÿßŸÜÿßÿ™ ŸÖÿ∂ÿßÿπŸÅ x5
            { name: 'ÿ≠ÿµÿßŸÜ', image: 'horse.png', points: 0, type: 'multiplier', effect: 'x5', multiplier: 5 },
            { name: 'ÿ¨ŸÖŸÑ', image: 'camel.png', points: 0, type: 'multiplier', effect: 'x5', multiplier: 5 },
            { name: 'ÿ∫ÿ≤ÿßŸÑ', image: 'deer.png', points: 0, type: 'multiplier', effect: 'x5', multiplier: 5 },

            // ÿ≠ŸäŸàÿßŸÜÿßÿ™ ŸÖÿ∂ÿßÿπŸÅ x8
            { name: 'ÿ∞ÿ¶ÿ®', image: 'wolf.png', points: 0, type: 'multiplier', effect: 'x8', multiplier: 8 },
            { name: 'ŸÜÿ≥ÿ±', image: 'eagle.png', points: 0, type: 'multiplier', effect: 'x8', multiplier: 8 },
            { name: 'ÿ®ŸàŸÖÿ©', image: 'owl.png', points: 0, type: 'multiplier', effect: 'x8', multiplier: 8 },

            // ÿ≠ŸäŸàÿßŸÜÿßÿ™ ŸÖÿ∂ÿßÿπŸÅ x10
            { name: 'ÿ£ÿ≥ÿØ', image: 'lion.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },
            { name: 'ŸÅŸäŸÑ', image: 'elephant.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },
            { name: 'ŸÜŸÖÿ±', image: 'tiger.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },
            { name: 'ÿ≤ÿ±ÿßŸÅÿ©', image: 'giraffe.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },
            { name: 'ÿ®ÿßŸÜÿØÿß', image: 'panda.png', points: 0, type: 'multiplier', effect: 'x10', multiplier: 10 },

            // ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ™ÿ£ÿÆÿ∞ ŸÇŸäŸÖÿ© ÿ¨ŸàŸÑÿ™ŸäŸÜ
            { name: 'ŸÉŸÜÿ∫ÿ±', image: 'kangaroo.png', points: 0, type: 'double_loss', effect: 'double_loss' },
            { name: 'ÿ®ÿ®ÿ∫ÿßÿ°', image: 'parrot.png', points: 0, type: 'double_loss', effect: 'double_loss' }
        ];

        // ÿßŸÑŸàÿ≠Ÿàÿ¥ (ÿ™ÿ≥ÿ®ÿ® ÿßŸÑÿÆÿ≥ÿßÿ±ÿ©)
        const monsters = [
            { name: 'Ÿàÿ≠ÿ¥', image: 'monster.png', type: 'monster' },
            { name: 'ÿ¥ÿ®ÿ≠', image: 'Ghost.png', type: 'monster' },
            { name: 'ÿ¥ÿ®ÿ≠ ÿ¢ÿÆÿ±', image: 'Ghost 2.png', type: 'monster' },
            { name: 'ÿπŸÅÿ±Ÿäÿ™', image: 'default-avatar.png', type: 'monster' }
        ];

        // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ£ÿµŸàÿßÿ™
        let audioContext;
        let audioInitialized = false;

        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('üîä ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸàÿ™ - ŸÑÿπÿ®ÿ© ÿßŸÑÿ∫ÿßÿ®ÿ©');
            } catch (error) {
                console.log('üîá Web Audio API ÿ∫Ÿäÿ± ŸÖÿØÿπŸàŸÖ');
                gameState.soundEnabled = false;
            }
        }

        function enableAudio() {
            if (!audioInitialized && audioContext) {
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        audioInitialized = true;
                        console.log('üîä ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸàÿ™ - ŸÑÿπÿ®ÿ© ÿßŸÑÿ∫ÿßÿ®ÿ©');
                        setTimeout(() => playSound('click'), 100);
                    });
                } else {
                    audioInitialized = true;
                    console.log('üîä ŸÜÿ∏ÿßŸÖ ÿßŸÑÿµŸàÿ™ ÿ¨ÿßŸáÿ≤ - ŸÑÿπÿ®ÿ© ÿßŸÑÿ∫ÿßÿ®ÿ©');
                }
            }
        }

        function playSound(type) {
            if (!gameState.soundEnabled || !audioContext) return;

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© AudioContext
            if (audioContext.state === 'suspended') {
                // ŸÑÿß ŸÜÿ≠ÿßŸàŸÑ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿπŸÑŸÇÿßŸã
                return;
            }

            if (!audioInitialized) {
                return; // ŸÑÿß ŸÜÿ≠ÿßŸàŸÑ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            }

            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                switch(type) {
                    case 'click':
                        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                        oscillator.type = 'sine';
                        break;

                    case 'discover':
                        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(900, audioContext.currentTime + 0.2);
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.type = 'triangle';
                        break;

                    case 'correct':
                        oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.3);
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                        oscillator.type = 'square';
                        break;

                    case 'wrong':
                        oscillator.frequency.setValueAtTime(300, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(150, audioContext.currentTime + 0.2);
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                        oscillator.type = 'sawtooth';
                        break;

                    case 'levelUp':
                        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.5);
                        gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        oscillator.type = 'sine';
                        break;

                    default:
                        return;
                }

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

            } catch (error) {
                console.log('üîá ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™');
            }
        }

        function toggleSound() {
            enableAudio();

            gameState.soundEnabled = !gameState.soundEnabled;
            const soundBtn = document.getElementById('sound-btn');

            if (gameState.soundEnabled) {
                soundBtn.textContent = 'üîä ÿßŸÑÿµŸàÿ™';
                soundBtn.style.opacity = '1';
                setTimeout(() => playSound('click'), 100);
            } else {
                soundBtn.textContent = 'üîá ÿµÿßŸÖÿ™';
                soundBtn.style.opacity = '0.6';
            }

            localStorage.setItem('forest-game-sound-enabled', gameState.soundEnabled);
        }

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
        function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = message;

            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('coins-count').textContent = gameState.coins;
            document.getElementById('discovered').textContent = gameState.gamesPlayed;
            document.getElementById('correct').textContent = gameState.wins;
            document.getElementById('wrong').textContent = gameState.losses;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('bet-amount').textContent = gameState.betAmount;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
            document.getElementById('player-gold').textContent = gameState.coins;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸáŸäÿØÿ± ÿßŸÑÿ≠ŸÇŸäŸÇŸä
            if (window.playerHeader && typeof window.playerHeader.updateBalance === 'function') {
                const currentPearls = parseInt(document.getElementById('player-pearls').textContent) || 0;
                window.playerHeader.updateBalance({
                    gold: gameState.coins,
                    pearls: currentPearls,
                    balance: gameState.coins
                });
                console.log('üí∞ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿµŸäÿØ ÿßŸÑŸáŸäÿØÿ±:', { gold: gameState.coins, pearls: currentPearls });
            }
        }

        // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ£ŸÇŸÅÿßÿµ
        function createCages() {
            const grid = document.getElementById('cages-grid');
            grid.innerHTML = '';

            for (let i = 0; i < 9; i++) {
                const cage = document.createElement('div');
                cage.className = 'cage';
                cage.dataset.index = i;
                cage.onclick = () => openCage(i);

                cage.innerHTML = `
                    <div class="cage-number">${i + 1}</div>
                    <img class="cage-cover" src="/images/OIP.jpg" alt="ÿµŸÜÿØŸàŸÇ" onerror="this.style.display='none'; this.parentNode.innerHTML += 'üì¶';">
                    <div class="cage-content">
                        <img class="revealed-image" src="" alt="">
                        <div class="revealed-name"></div>
                        <div class="revealed-result"></div>
                    </div>
                `;

                grid.appendChild(cage);
            }
        }

        // ÿßÿÆÿ™Ÿäÿßÿ± ŸáÿØŸÅ ÿπÿ¥Ÿàÿßÿ¶Ÿä
        function selectRandomTarget() {
            const randomAnimal = animals[Math.floor(Math.random() * animals.length)];
            gameState.targetAnimal = randomAnimal;

            // ÿπÿ±ÿ∂ ÿßŸÑŸáÿØŸÅ
            document.getElementById('target-image').src = `/images/${randomAnimal.image}`;
            document.getElementById('target-image').onerror = function() {
                this.src = '/images/default-avatar.png';
            };
            document.getElementById('target-name').textContent = randomAnimal.name;
            document.getElementById('target-reward').textContent = `+${randomAnimal.points} ÿπŸÖŸÑÿ©`;

            document.getElementById('target-animal').style.display = 'block';
            document.getElementById('start-message').style.display = 'none';
        }

        // ŸÖŸÑÿ° ÿßŸÑÿ£ŸÇŸÅÿßÿµ ÿ®ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿπÿ¥Ÿàÿßÿ¶Ÿä
        function fillCages() {
            gameState.cageContents = [];

            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸáÿØŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ŸÅŸä ŸÇŸÅÿµ ÿπÿ¥Ÿàÿßÿ¶Ÿä
            const targetPosition = Math.floor(Math.random() * 9);

            // ÿ•ÿ∂ÿßŸÅÿ© 1-2 Ÿàÿ≠Ÿàÿ¥ ŸÅŸä ŸÖŸàÿßŸÇÿπ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
            const numMonsters = Math.random() < 0.7 ? 1 : 2; // 70% ÿßÿ≠ÿ™ŸÖÿßŸÑ Ÿàÿ≠ÿ¥ Ÿàÿßÿ≠ÿØÿå 30% Ÿàÿ≠ÿ¥ŸäŸÜ
            const monsterPositions = [];

            for (let m = 0; m < numMonsters; m++) {
                let monsterPosition;
                do {
                    monsterPosition = Math.floor(Math.random() * 9);
                } while (monsterPosition === targetPosition || monsterPositions.includes(monsterPosition));
                monsterPositions.push(monsterPosition);
            }

            // ŸÖŸÑÿ° ÿßŸÑÿ£ŸÇŸÅÿßÿµ
            for (let i = 0; i < 9; i++) {
                if (i === targetPosition) {
                    // ÿßŸÑŸáÿØŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®
                    gameState.cageContents[i] = { ...gameState.targetAnimal, isTarget: true };
                } else if (monsterPositions.includes(i)) {
                    // Ÿàÿ≠ÿ¥ ÿπÿ¥Ÿàÿßÿ¶Ÿä
                    const randomMonster = monsters[Math.floor(Math.random() * monsters.length)];
                    gameState.cageContents[i] = { ...randomMonster, isTarget: false };
                } else {
                    // ÿ≠ŸäŸàÿßŸÜ ÿπÿ¥Ÿàÿßÿ¶Ÿä ÿ¢ÿÆÿ±
                    const randomAnimal = animals[Math.floor(Math.random() * animals.length)];
                    gameState.cageContents[i] = { ...randomAnimal, isTarget: false };
                }
            }
        }

        // ŸÅÿ™ÿ≠ ŸÇŸÅÿµ
        async function openCage(index) {
            // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿπŸÜÿØ ÿ£ŸàŸÑ ÿ™ŸÅÿßÿπŸÑ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            enableAudio();

            if (!gameState.isPlaying) {
                // ÿ®ÿØÿ° ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                const canStart = await startNewRound();
                if (!canStart) {
                    return;
                }
                gameState.isPlaying = true;
            }

            const cage = document.querySelector(`[data-index="${index}"]`);
            if (cage.classList.contains('opened')) {
                return; // ÿßŸÑŸÇŸÅÿµ ŸÖŸÅÿ™Ÿàÿ≠ ÿ®ÿßŸÑŸÅÿπŸÑ
            }

            // ÿ™ÿπÿ∑ŸäŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇŸÅÿßÿµ
            document.querySelectorAll('.cage').forEach(c => c.classList.add('disabled'));

            const content = gameState.cageContents[index];

            // ÿ™ÿ£ÿ´Ÿäÿ± ŸÅÿ™ÿ≠ ÿßŸÑŸÇŸÅÿµ
            cage.classList.add('opening');

            // ŸÅÿ™ÿ≠ ÿßŸÑŸÇŸÅÿµ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ£ÿ´Ÿäÿ±
            setTimeout(() => {
                cage.classList.remove('opening');
                cage.classList.add('opened');
            }, 250);

            // ÿπÿ±ÿ∂ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
            const image = cage.querySelector('.revealed-image');
            const name = cage.querySelector('.revealed-name');
            const result = cage.querySelector('.revealed-result');

            image.src = `/images/${content.image}`;
            image.onerror = function() {
                this.src = '/images/default-avatar.png';
            };
            name.textContent = content.name;

            let resultText = '';
            let resultClass = '';
            let coinChange = 0;

            if (content.type === 'monster') {
                // Ÿàÿ≠ÿ¥ - ÿÆÿ≥ÿßÿ±ÿ©
                resultText = `ÿÆÿ≥ÿßÿ±ÿ©: -${gameState.betAmount}`;
                resultClass = 'result-lose';
                coinChange = -gameState.betAmount;
                gameState.losses++;
                playSound('wrong');
                showMessage(`üíÄ Ÿàÿ≠ÿ¥! ÿÆÿ≥ÿ±ÿ™ ${gameState.betAmount} ÿπŸÖŸÑÿ©`, 'error');
            } else if (content.isTarget) {
                // ÿßŸÑŸáÿØŸÅ ÿßŸÑŸÖÿ∑ŸÑŸàÿ® - ŸÅŸàÿ≤ ŸÉÿ®Ÿäÿ±
                if (content.type === 'multiplier') {
                    coinChange = gameState.betAmount * content.multiplier;
                    resultText = `üéØ ÿßŸÑŸáÿØŸÅ! x${content.multiplier}`;
                    resultClass = 'result-target';
                    playSound('levelUp');
                    showMessage(`üéØ ŸÖŸÖÿ™ÿßÿ≤! Ÿàÿ¨ÿØÿ™ ÿßŸÑŸáÿØŸÅ! ŸÖÿ∂ÿßÿπŸÅ x${content.multiplier}! +${coinChange} ÿπŸÖŸÑÿ©`, 'success');
                } else if (content.type === 'refund') {
                    coinChange = gameState.betAmount;
                    resultText = `üéØ ÿßŸÑŸáÿØŸÅ! ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ`;
                    resultClass = 'result-target';
                    playSound('levelUp');
                    showMessage(`üéØ ŸÖŸÖÿ™ÿßÿ≤! Ÿàÿ¨ÿØÿ™ ÿßŸÑŸáÿØŸÅ! ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ ${coinChange} ÿπŸÖŸÑÿ©`, 'success');
                } else if (content.type === 'double_loss') {
                    coinChange = -gameState.betAmount;
                    resultText = `üéØ ÿßŸÑŸáÿØŸÅ! ÿÆÿ≥ÿßÿ±ÿ© ŸÖÿ∂ÿßÿπŸÅÿ©`;
                    resultClass = 'result-double-loss';
                    playSound('wrong');
                    showMessage(`üéØ Ÿàÿ¨ÿØÿ™ ÿßŸÑŸáÿØŸÅ ŸÑŸÉŸÜŸá ÿÆÿ∑Ÿäÿ±! ÿÆÿ≥ÿ±ÿ™ ${Math.abs(coinChange)} ÿπŸÖŸÑÿ©`, 'error');
                } else {
                    coinChange = content.points;
                    resultText = `üéØ ÿßŸÑŸáÿØŸÅ! +${content.points}`;
                    resultClass = 'result-target';
                    playSound('levelUp');
                    showMessage(`üéØ ŸÖŸÖÿ™ÿßÿ≤! Ÿàÿ¨ÿØÿ™ ÿßŸÑŸáÿØŸÅ! +${content.points} ÿπŸÖŸÑÿ©`, 'success');
                }
                gameState.wins++;
            } else {
                // ÿ≠ŸäŸàÿßŸÜ ÿ¢ÿÆÿ± - ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ©
                if (content.type === 'multiplier') {
                    coinChange = gameState.betAmount * content.multiplier;
                    resultText = `ŸÖÿ∂ÿßÿπŸÅ x${content.multiplier}!`;
                    resultClass = 'result-multiplier';
                    playSound('levelUp');
                    showMessage(`üéâ ŸÖÿ∂ÿßÿπŸÅ ÿ±ÿßÿ¶ÿπ! x${content.multiplier}! +${coinChange} ÿπŸÖŸÑÿ©`, 'success');
                } else if (content.type === 'refund') {
                    coinChange = gameState.betAmount;
                    resultText = `ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ`;
                    resultClass = 'result-win';
                    playSound('correct');
                    showMessage(`üí∞ ÿ™ŸÖ ÿßÿ≥ÿ™ÿ±ÿØÿßÿØ ŸÇŸäŸÖÿ© ÿßŸÑÿ¨ŸàŸÑÿ©: +${coinChange} ÿπŸÖŸÑÿ©`, 'info');
                } else if (content.type === 'double_loss') {
                    coinChange = -gameState.betAmount * 2;
                    resultText = `ÿÆÿ≥ÿßÿ±ÿ© ŸÖÿ∂ÿßÿπŸÅÿ©!`;
                    resultClass = 'result-double-loss';
                    playSound('wrong');
                    showMessage(`üí∏ ÿÆÿ≥ÿßÿ±ÿ© ŸÖÿ∂ÿßÿπŸÅÿ©! ÿÆÿ≥ÿ±ÿ™ ${Math.abs(coinChange)} ÿπŸÖŸÑÿ©`, 'error');
                } else {
                    coinChange = content.points;
                    resultText = `+${content.points}`;
                    resultClass = 'result-win';
                    playSound('correct');
                    showMessage(`‚úÖ ÿ≠ŸäŸàÿßŸÜ ÿ¨ŸÖŸäŸÑ! +${content.points} ÿπŸÖŸÑÿ©`, 'success');
                }
                gameState.wins++;
            }

            result.textContent = resultText;
            result.className = `revealed-result ${resultClass}`;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπŸÖŸÑÿßÿ™ ŸàÿßŸÑŸÜŸÇÿßÿ∑
            gameState.coins += coinChange;
            gameState.score += Math.max(0, coinChange);
            gameState.gamesPlayed++;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
            await updateEconomyBalance(coinChange);

            updateDisplay();
            saveGameData();

            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ£ŸÇŸÅÿßÿµ ÿ®ÿπÿØ 2.5 ÿ´ÿßŸÜŸäÿ©
            setTimeout(() => {
                resetCagesForNextRound();
            }, 2500);
        }

        // ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®
        async function refreshPlayerData() {
            console.log('üîÑ ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®...');
            await loadPlayerData();
            updateDisplay();
        }

        // ÿØÿßŸÑÿ© ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿÆŸÑŸÅ
        function goBack() {
            // ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿµŸàÿ™ ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ±
            enableAudio();
            playSound('click');

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©
            if (gameState.isPlaying && gameState.gamesPlayed > 0) {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÑÿßÿπÿ® ŸÅŸä ŸÖŸÜÿ™ÿµŸÅ ÿßŸÑŸÑÿπÿ®ÿ©ÿå ÿ∑ŸÑÿ® ÿßŸÑÿ™ÿ£ŸÉŸäÿØ
                const confirmExit = confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü ÿ≥ÿ™ŸÅŸÇÿØ ÿßŸÑÿ™ŸÇÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ©.');
                if (!confirmExit) {
                    return; // ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿÆÿ±Ÿàÿ¨
                }
            }

            // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            saveGameData();

            // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
            if (document.referrer &&
                document.referrer !== window.location.href &&
                !document.referrer.includes('forest-game.html')) {
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿµŸÅÿ≠ÿ© ÿ≥ÿßÿ®ŸÇÿ© ÿµÿ≠Ÿäÿ≠ÿ©ÿå ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸäŸáÿß
                window.history.back();
            } else {
                // ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸáŸÜÿßŸÉ ÿµŸÅÿ≠ÿ© ÿ≥ÿßÿ®ŸÇÿ© ÿµÿ≠Ÿäÿ≠ÿ©ÿå ÿßŸÑÿ∞Ÿáÿßÿ® ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
                window.location.href = '/';
            }
        }

        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ£ŸÇŸÅÿßÿµ ŸÑŸÑÿ¨ŸàŸÑÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©
        function resetCagesForNextRound() {
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ£ŸÇŸÅÿßÿµ
            document.querySelectorAll('.cage').forEach(cage => {
                cage.classList.remove('opened', 'disabled');
            });

            // ÿßÿÆÿ™Ÿäÿßÿ± ŸáÿØŸÅ ÿ¨ÿØŸäÿØ ŸàŸÖŸÑÿ° ÿßŸÑÿ£ŸÇŸÅÿßÿµ
            selectRandomTarget();
            fillCages();

            // ŸÅÿ≠ÿµ ÿßŸÑÿßÿ±ÿ™ŸÇÿßÿ° ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä
            if (gameState.wins >= gameState.level * 3) {
                gameState.level++;
                gameState.betAmount += 10; // ÿ≤ŸäÿßÿØÿ© ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ¨ŸàŸÑÿ©
                playSound('levelUp');
                showMessage(`üéâ ŸÖÿ®ÿ±ŸàŸÉ! ŸàÿµŸÑÿ™ ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ${gameState.level}!`, 'success');
                updateDisplay();
            }

            showMessage('üîÑ ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©! ÿßÿÆÿ™ÿ± ÿµŸÜÿØŸàŸÇÿßŸã ÿ¢ÿÆÿ±', 'info');
        }

        // ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ©
        function endGame() {
            gameState.isPlaying = false;

            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ£ŸÇŸÅÿßÿµ
            document.querySelectorAll('.cage').forEach(cage => {
                cage.classList.remove('opened', 'disabled');
            });

            // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸáÿØŸÅ
            document.getElementById('target-animal').style.display = 'none';
            document.getElementById('start-message').style.display = 'block';
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
        async function initializeEconomy() {
            try {
                if (window.gameEconomy && typeof window.gameEconomy.initializeGameSession === 'function') {
                    gameState.economySession = await window.gameEconomy.initializeGameSession('forest-game', gameState.betAmount);
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä ŸÑŸÑÿπÿ®ÿ© ÿßŸÑÿ∫ÿßÿ®ÿ©');
                } else {
                    console.log('üéÆ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ© ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿØÿ±Ÿäÿ®');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä:', error);
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑÿ≠ŸÇŸäŸÇŸä
        async function loadPlayerData() {
            try {
                console.log('üîÑ ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®...');

                // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸáŸäÿØÿ±
                if (window.playerHeader) {
                    // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® ŸÖŸÜ ÿÆÿµÿßÿ¶ÿµ ÿßŸÑŸáŸäÿØÿ±
                    const playerName = window.playerHeader.username || 'ÿßŸÑŸÑÿßÿπÿ®';
                    const playerBalance = window.playerHeader.balance || gameState.coins;
                    const playerId = window.playerHeader.playerId || '';
                    const playerAvatar = window.playerHeader.avatar || '/images/default-avatar.png';

                    console.log('üë§ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® ŸÖŸÜ ÿßŸÑŸáŸäÿØÿ±:', {
                        username: playerName,
                        balance: playerBalance,
                        playerId: playerId,
                        avatar: playerAvatar
                    });

                    // ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑÿ≠ŸÇŸäŸÇŸä
                    document.getElementById('player-name').textContent = playerName;
                    document.getElementById('player-level').textContent = `ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1`; // ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿ≥ŸäŸÜŸá ŸÑÿßÿ≠ŸÇÿßŸã

                    // ÿ™ÿ≠ÿØŸäÿ´ ÿµŸàÿ±ÿ© ÿßŸÑŸÑÿßÿπÿ®
                    if (playerAvatar && playerAvatar !== '/images/default-avatar.png') {
                        document.getElementById('player-avatar').src = playerAvatar;
                        document.getElementById('player-avatar').onerror = function() {
                            this.src = '/images/default-avatar.png';
                        };
                    }

                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑÿ≠ŸÇŸäŸÇŸä
                    if (typeof playerBalance === 'number' && playerBalance > 0) {
                        gameState.coins = playerBalance;
                        document.getElementById('player-gold').textContent = playerBalance;
                        console.log('üí∞ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸÜ ÿßŸÑŸáŸäÿØÿ±:', playerBalance);
                    } else {
                        // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
                        if (window.gameEconomy && typeof window.gameEconomy.getPlayerBalance === 'function') {
                            try {
                                const economyBalance = await window.gameEconomy.getPlayerBalance();
                                if (economyBalance && economyBalance.gold) {
                                    gameState.coins = economyBalance.gold;
                                    document.getElementById('player-gold').textContent = economyBalance.gold;
                                    document.getElementById('player-pearls').textContent = economyBalance.pearls || 0;
                                    console.log('üí∞ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä:', economyBalance);
                                } else {
                                    document.getElementById('player-gold').textContent = gameState.coins;
                                    document.getElementById('player-pearls').textContent = 0;
                                }
                            } catch (economyError) {
                                console.log('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä:', economyError);
                                document.getElementById('player-gold').textContent = gameState.coins;
                                document.getElementById('player-pearls').textContent = 0;
                            }
                        } else {
                            document.getElementById('player-gold').textContent = gameState.coins;
                            document.getElementById('player-pearls').textContent = 0;
                        }
                    }

                    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÖŸÜ localStorage
                    const userData = localStorage.getItem('userData');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            if (user.level) {
                                document.getElementById('player-level').textContent = `ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ${user.level}`;
                            }
                            console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÖŸÜ localStorage:', user);
                        } catch (parseError) {
                            console.log('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ localStorage:', parseError);
                        }
                    }

                    // ÿ•ÿ∏Ÿáÿßÿ± ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®
                    document.getElementById('player-info').style.display = 'flex';
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® ÿ®ŸÜÿ¨ÿßÿ≠');

                } else {
                    console.log('‚ùå window.playerHeader ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠');
                    // ŸÖÿ≠ÿßŸàŸÑÿ© ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ localStorage
                    const userData = localStorage.getItem('userData');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            document.getElementById('player-name').textContent = user.username || 'ÿßŸÑŸÑÿßÿπÿ®';
                            document.getElementById('player-level').textContent = `ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ ${user.level || 1}`;
                            if (user.profilePicture || user.avatar) {
                                document.getElementById('player-avatar').src = user.profilePicture || user.avatar;
                            }
                            if (user.balance || user.coins) {
                                gameState.coins = user.balance || user.coins;
                                document.getElementById('player-gold').textContent = gameState.coins;
                            } else {
                                document.getElementById('player-gold').textContent = gameState.coins;
                            }
                            document.getElementById('player-pearls').textContent = user.pearls || 0;
                            console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ localStorage:', user);
                        } catch (parseError) {
                            console.log('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÑŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ localStorage:', parseError);
                            // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                            document.getElementById('player-name').textContent = 'ÿßŸÑŸÑÿßÿπÿ®';
                            document.getElementById('player-level').textContent = 'ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1';
                            document.getElementById('player-gold').textContent = gameState.coins;
                            document.getElementById('player-pearls').textContent = 0;
                        }
                    } else {
                        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                        document.getElementById('player-name').textContent = 'ÿßŸÑŸÑÿßÿπÿ®';
                        document.getElementById('player-level').textContent = 'ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1';
                        document.getElementById('player-gold').textContent = gameState.coins;
                        document.getElementById('player-pearls').textContent = 0;
                    }
                    document.getElementById('player-info').style.display = 'flex';
                }

            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿßÿπÿ®:', error);
                // ÿπÿ±ÿ∂ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£
                document.getElementById('player-name').textContent = 'ÿßŸÑŸÑÿßÿπÿ®';
                document.getElementById('player-level').textContent = 'ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ 1';
                document.getElementById('player-gold').textContent = gameState.coins;
                document.getElementById('player-pearls').textContent = 0;
                document.getElementById('player-info').style.display = 'flex';
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©
        function loadGameData() {
            try {
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©
                const savedData = localStorage.getItem('forest-game-data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    gameState.score = data.score || 0;
                    gameState.gamesPlayed = data.gamesPlayed || 0;
                    gameState.wins = data.wins || 0;
                    gameState.losses = data.losses || 0;
                    gameState.level = data.level || 1;
                    gameState.betAmount = data.betAmount || 50;
                }

                // ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿµŸàÿ™
                const soundSetting = localStorage.getItem('forest-game-sound-enabled');
                if (soundSetting !== null) {
                    gameState.soundEnabled = soundSetting === 'true';
                }
            } catch (error) {
                console.log('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
            }
        }

        // ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©
        function saveGameData() {
            try {
                const dataToSave = {
                    score: gameState.score,
                    gamesPlayed: gameState.gamesPlayed,
                    wins: gameState.wins,
                    losses: gameState.losses,
                    level: gameState.level,
                    betAmount: gameState.betAmount
                };
                localStorage.setItem('forest-game-data', JSON.stringify(dataToSave));
            } catch (error) {
                console.log('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
            }
        }

        // ÿ•ŸÜÿ¥ÿßÿ° ÿ¥ÿ®ŸÉÿ© ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™
        function createAnimalsGrid() {
            const grid = document.getElementById('animals-grid');
            grid.innerHTML = '';

            // ÿßÿÆÿ™Ÿäÿßÿ± ÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ© ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ
            const animalsToShow = getAnimalsForLevel(gameState.level);

            animalsToShow.forEach((animal, index) => {
                const card = document.createElement('div');
                card.className = 'animal-card';
                card.onclick = () => discoverAnimal(animal);

                card.innerHTML = `
                    <img src="/images/${animal.image}" alt="${animal.name}" class="animal-image"
                         onerror="this.src='/images/default-avatar.png'">
                    <div class="animal-name">‚ùì</div>
                    <div class="animal-points">+${animal.points}</div>
                `;

                grid.appendChild(card);
            });
        }

        // ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ
        function getAnimalsForLevel(level) {
            const animalsPerLevel = Math.min(6 + level, 12);
            const shuffled = [...animals].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, animalsPerLevel);
        }

        // ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ≠ŸäŸàÿßŸÜ
        async function discoverAnimal(animal) {
            if (!gameState.isPlaying) {
                showMessage('ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®ÿ© ÿ£ŸàŸÑÿßŸã!', 'error');
                return;
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿπŸÖŸÑÿßÿ™
            if (gameState.coins < gameState.discoveryCost) {
                showMessage('üí∞ ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿπŸÖŸÑÿßÿ™ ŸÉÿßŸÅŸäÿ© ŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ ÿßŸÑÿ≠ŸäŸàÿßŸÜ!', 'error');
                return;
            }

            // ÿÆÿµŸÖ ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿßŸÉÿ™ÿ¥ÿßŸÅ
            gameState.coins -= gameState.discoveryCost;
            gameState.discovered++;

            playSound('discover');

            // ÿπÿ±ÿ∂ ÿ≥ÿ§ÿßŸÑ ÿπŸÜ ÿßŸÑÿ≠ŸäŸàÿßŸÜ
            const isCorrect = await askAnimalQuestion(animal);

            if (isCorrect) {
                gameState.correct++;
                gameState.score += animal.points;
                gameState.coins += animal.points;

                playSound('correct');
                showMessage(`‚úÖ ÿµÿ≠Ÿäÿ≠! +${animal.points} ŸÜŸÇÿ∑ÿ© Ÿà +${animal.points} ÿπŸÖŸÑÿ©`, 'success');

                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
                updateEconomyBalance(animal.points);
            } else {
                gameState.wrong++;
                playSound('wrong');
                showMessage(`‚ùå ÿÆÿ∑ÿ£! ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©: ${animal.name}`, 'error');
            }

            // ŸÅÿ≠ÿµ ÿßŸÑÿßÿ±ÿ™ŸÇÿßÿ° ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä
            checkLevelUp();

            updateDisplay();
            saveGameData();
        }

        // ÿ≥ÿ§ÿßŸÑ ÿπŸÜ ÿßŸÑÿ≠ŸäŸàÿßŸÜ
        function askAnimalQuestion(animal) {
            return new Promise((resolve) => {
                const options = generateAnimalOptions(animal);
                const question = `üêæ ŸÖÿß ÿßÿ≥ŸÖ Ÿáÿ∞ÿß ÿßŸÑÿ≠ŸäŸàÿßŸÜÿü`;

                let optionsText = '';
                options.forEach((option, index) => {
                    optionsText += `${index + 1}. ${option}\n`;
                });

                const userAnswer = prompt(`${question}\n\n${optionsText}\nÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© (1-4):`);

                if (userAnswer && parseInt(userAnswer) === options.indexOf(animal.name) + 1) {
                    resolve(true);
                } else {
                    resolve(false);
                }
            });
        }

        // ÿ™ŸàŸÑŸäÿØ ÿÆŸäÿßÿ±ÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©
        function generateAnimalOptions(correctAnimal) {
            const options = [correctAnimal.name];
            const otherAnimals = animals.filter(a => a.name !== correctAnimal.name);

            // ÿ•ÿ∂ÿßŸÅÿ© 3 ÿÆŸäÿßÿ±ÿßÿ™ ÿÆÿßÿ∑ÿ¶ÿ© ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
            while (options.length < 4) {
                const randomAnimal = otherAnimals[Math.floor(Math.random() * otherAnimals.length)];
                if (!options.includes(randomAnimal.name)) {
                    options.push(randomAnimal.name);
                }
            }

            // ÿÆŸÑÿ∑ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™
            return options.sort(() => Math.random() - 0.5);
        }

        // ŸÅÿ≠ÿµ ÿßŸÑÿßÿ±ÿ™ŸÇÿßÿ° ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ™ÿßŸÑŸä
        function checkLevelUp() {
            const requiredCorrect = gameState.level * 5;
            if (gameState.correct >= requiredCorrect) {
                gameState.level++;
                playSound('levelUp');
                showMessage(`üéâ ŸÖÿ®ÿ±ŸàŸÉ! ŸàÿµŸÑÿ™ ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ${gameState.level}!`, 'success');

                // ÿ•ÿπÿßÿØÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ¥ÿ®ŸÉÿ© ŸÑŸÑŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ¨ÿØŸäÿØ
                createAnimalsGrid();
            }
        }

        // ÿ™ÿ≠ÿØŸäÿ´ ÿ±ÿµŸäÿØ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
        async function updateEconomyBalance(coinChange) {
            try {
                // ÿ™ÿÆÿ∑Ÿä ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸáŸÜÿßŸÉ ÿ™ÿ∫ŸäŸäÿ± ŸÅŸä ÿßŸÑÿπŸÖŸÑÿßÿ™
                if (coinChange === 0) return;

                console.log('üí∞ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ:', coinChange);

                if (window.gameEconomy && typeof window.gameEconomy.updatePlayerBalance === 'function') {
                    const gameResult = {
                        isWin: coinChange > 0,
                        winAmount: Math.max(0, coinChange),
                        lossAmount: Math.abs(Math.min(0, coinChange)),
                        totalWin: Math.max(0, coinChange),
                        totalBet: gameState.betAmount,
                        gameType: 'forest-game'
                    };

                    const balanceUpdate = await window.gameEconomy.updatePlayerBalance(gameResult);
                    if (balanceUpdate && balanceUpdate.success) {
                        console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä ÿ®ŸÜÿ¨ÿßÿ≠:', balanceUpdate);

                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ÿßŸÑŸÖÿ≠ŸÑŸä
                        if (balanceUpdate.newBalance && typeof balanceUpdate.newBalance.gold === 'number') {
                            gameState.coins = balanceUpdate.newBalance.gold;
                        }

                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸáŸäÿØÿ±
                        if (window.playerHeader && typeof window.playerHeader.updateBalance === 'function') {
                            window.playerHeader.updateBalance(balanceUpdate.newBalance);
                        }

                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
                        updateDisplay();
                    } else {
                        console.log('‚ö†Ô∏è ŸÅÿ¥ŸÑ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä:', balanceUpdate);
                    }
                } else {
                    console.log('‚ö†Ô∏è ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠');
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä:', error);
                // ŸÑÿß ŸÜŸàŸÇŸÅ ÿßŸÑŸÑÿπÿ®ÿ© ÿ®ÿ≥ÿ®ÿ® ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
            }
        }

        // ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©
        function startGame() {
            // ŸÑÿß ŸÜÿ¥ÿ∫ŸÑ ÿßŸÑÿµŸàÿ™ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ŸÑÿ™ÿ¨ŸÜÿ® ŸÖÿ¥ÿßŸÉŸÑ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
            gameState.isPlaying = true;
            selectRandomTarget();
            fillCages();

            showMessage(`üå≤ ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ${gameState.targetAnimal.name} ŸÅŸä ÿßŸÑÿµŸÜÿßÿØŸäŸÇ!`, 'info');
            updateDisplay();
        }

        // ÿ®ÿØÿ° ÿ¨ŸàŸÑÿ© ÿ¨ÿØŸäÿØÿ©
        async function startNewRound() {
            try {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
                if (window.gameEconomy && typeof window.gameEconomy.canPlay === 'function') {
                    const canPlayCheck = window.gameEconomy.canPlay(gameState.betAmount);
                    if (!canPlayCheck.canPlay) {
                        showMessage(canPlayCheck.reason || 'ŸÑÿß ŸäŸÖŸÉŸÜ ÿ®ÿØÿ° ÿßŸÑÿ¨ŸàŸÑÿ©', 'error');
                        endGame();
                        return false;
                    }
                }

                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿπŸÖŸÑÿßÿ™
                if (gameState.coins < gameState.betAmount) {
                    showMessage(`üí∞ ÿ™ÿ≠ÿ™ÿßÿ¨ ${gameState.betAmount} ÿπŸÖŸÑÿ© ŸÑÿ®ÿØÿ° ÿßŸÑÿ¨ŸàŸÑÿ©!`, 'error');
                    endGame();
                    return false;
                }

                // ÿÆÿµŸÖ ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ¨ŸàŸÑÿ©
                gameState.coins -= gameState.betAmount;
                updateDisplay();

                return true;
            } catch (error) {
                console.log('‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ®ÿØÿ° ÿßŸÑÿ¨ŸàŸÑÿ©:', error);
                return false;
            }
        }

        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÑÿπÿ®ÿ©
        function resetGame() {
            if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÑÿπÿ®ÿ©ÿü ÿ≥ÿ™ŸÅŸÇÿØ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ™ŸÇÿØŸÖ!')) {
                gameState.score = 0;
                gameState.gamesPlayed = 0;
                gameState.wins = 0;
                gameState.losses = 0;
                gameState.level = 1;
                gameState.betAmount = 50;
                gameState.isPlaying = false;

                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ£ŸÇŸÅÿßÿµ
                document.querySelectorAll('.cage').forEach(cage => {
                    cage.classList.remove('opened', 'disabled');
                });

                // ÿ®ÿØÿ° ŸÑÿπÿ®ÿ© ÿ¨ÿØŸäÿØÿ©
                startGame();

                updateDisplay();
                saveGameData();

                showMessage('üîÑ ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÑÿπÿ®ÿ©!', 'info');
                playSound('click');
            }
        }

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ≤ÿ± ÿßŸÑÿÆŸÑŸÅ ŸÅŸä ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
        window.addEventListener('beforeunload', function(e) {
            if (gameState.isPlaying && gameState.gamesPlayed > 0) {
                // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
                saveGameData();

                // ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ≠ÿ∞Ÿäÿ±Ÿäÿ© (ŸÇÿØ ŸÑÿß ÿ™ÿ∏Ÿáÿ± ŸÅŸä ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ÿßÿ™)
                const message = 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü ÿ≥ÿ™ŸÅŸÇÿØ ÿßŸÑÿ™ŸÇÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ©.';
                e.returnValue = message;
                return message;
            }
        });

        // ŸÖÿπÿßŸÑÿ¨ÿ© ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿ≤ÿ± ÿßŸÑÿÆŸÑŸÅ)
        window.addEventListener('popstate', function(e) {
            if (gameState.isPlaying && gameState.gamesPlayed > 0) {
                const confirmExit = confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü ÿ≥ÿ™ŸÅŸÇÿØ ÿßŸÑÿ™ŸÇÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸä ÿßŸÑŸÑÿπÿ®ÿ©.');
                if (!confirmExit) {
                    // ŸÖŸÜÿπ ÿßŸÑÿÆÿ±Ÿàÿ¨ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿßŸÑÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ™ÿßÿ±ŸäÿÆ
                    history.pushState(null, null, window.location.href);
                    return;
                }
            }
            // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨
            saveGameData();
        });

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿπÿ®ÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ≠ÿßŸÑÿ© ŸÑŸÑÿ™ÿßÿ±ŸäÿÆ ŸÑŸÖÿπÿßŸÑÿ¨ÿ© ÿ≤ÿ± ÿßŸÑÿÆŸÑŸÅ
                history.pushState(null, null, window.location.href);

                // ÿ™ŸáŸäÿ¶ÿ© ŸáŸäÿØÿ± ÿßŸÑŸÑÿßÿπÿ® ÿ£ŸàŸÑÿßŸã
                if (window.playerHeader && typeof window.playerHeader.init === 'function') {
                    await window.playerHeader.init();
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸáŸäÿØÿ± ÿßŸÑŸÑÿßÿπÿ®');
                } else {
                    console.log('‚ö†Ô∏è ŸáŸäÿØÿ± ÿßŸÑŸÑÿßÿπÿ® ÿ∫Ÿäÿ± ŸÖÿ™ÿßÿ≠');
                }

                initAudio();
                loadPlayerData();
                loadGameData();
                await initializeEconomy();
                createCages();
                startGame(); // ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
                updateDisplay();
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÑÿπÿ®ÿ©:', error);
                // ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ© ÿ≠ÿ™Ÿâ ŸÑŸà ŸÅÿ¥ŸÑÿ™ ÿßŸÑÿ™ŸáŸäÿ¶ÿ©
                initAudio();
                loadGameData();
                createCages();
                startGame();
                updateDisplay();
            }
        });
    </script>
</body>
</html>
