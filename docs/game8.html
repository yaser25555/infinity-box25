<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÑÿπÿ®ÿ© ÿßŸÑÿµŸÜÿßÿØŸäŸÇ</title>
    <script src="js/translations.js"></script>
    <script src="js/game-economy.js"></script>
    <script src="js/player-header.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #2c5282 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .player-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .player-avatar {
            width: 50px;
            height: 50px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .player-data {
            text-align: left;
        }
        
        .player-name {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .player-balance {
            color: #ffd700;
            font-weight: bold;
        }
        
        .home-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        
        .home-btn:hover {
            background: #059669;
        }
        
        .game-title {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 30px;
        }
        
        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 400px;
            margin: 30px auto;
        }
        
        .box {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.3);
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .box:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.5);
        }
        
        .box.opened {
            background: #666;
            cursor: default;
        }
        
        .box.win {
            background: #10b981;
        }
        
        .box.loss {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .box.empty {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: #d1d5db;
        }

        .box-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
            padding: 4px;
        }

        .box-emoji {
            font-size: 1.2em;
            margin-bottom: 2px;
        }

        .box-value {
            font-size: 0.5em;
            font-weight: bold;
            margin-bottom: 1px;
            line-height: 1;
        }

        .box-name {
            font-size: 0.25em;
            opacity: 0.8;
            line-height: 1;
            text-align: center;
        }

        /* ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿßŸÑÿµŸÜÿßÿØŸäŸÇ */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .box.big-win {
            animation: pulse 0.5s ease-in-out 3;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .bet-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .bet-button:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .bet-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .message.success { color: #10b981; }
        .message.error { color: #ef4444; }
        .message.info { color: #ffd700; }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿ¨ŸàÿßŸÑ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                max-width: 100vw;
                padding: 8px;
                margin: 2px;
                box-sizing: border-box;
            }

            .header {
                margin-bottom: 5px;
                padding: 4px 6px;
                flex-wrap: wrap;
            }

            .game-title {
                font-size: 0.9em;
                order: 1;
                flex: 1;
                text-align: center;
            }

            .back-btn {
                width: 30px;
                height: 30px;
                font-size: 1em;
                order: 0;
            }

            .stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
                margin: 5px 0;
            }

            .stat-item {
                padding: 4px 6px;
                border-radius: 6px;
            }

            .stat-value {
                font-size: 1em;
            }

            .stat-label {
                font-size: 0.7em;
            }

            .boxes-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin: 10px 0;
                max-width: 100%;
            }

            .box {
                width: 80px;
                height: 80px;
                font-size: 2em;
                border-radius: 8px;
            }

            .box-number {
                font-size: 0.6em;
                top: 2px;
                left: 2px;
                width: 16px;
                height: 16px;
            }

            .controls {
                gap: 4px;
                margin: 8px 0;
                flex-wrap: wrap;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 0.75em;
                border-radius: 8px;
                flex: 1;
                min-width: 100px;
            }

            .result-message {
                padding: 8px;
                font-size: 0.8em;
                margin: 8px 0;
                border-radius: 8px;
            }

            .debug-panel {
                font-size: 0.7em;
                padding: 6px;
                max-height: 120px;
            }
        }

        @media (max-width: 480px) {
            .boxes-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .box {
                width: 70px;
                height: 70px;
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: center;
                gap: 6px;
            }

            .control-btn {
                width: 100%;
                max-width: 200px;
                margin: 2px 0;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÑÿßÿπÿ® -->
        <div id="player-header-container">
            <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿØÿ±ÿßÿ¨ ŸáŸäÿØÿ± ÿßŸÑŸÑÿßÿπÿ® ŸáŸÜÿß ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
        </div>
        
        <h1 class="game-title">üéÅ ÿµŸÜÿßÿØŸäŸÇ ÿßŸÑÿ≠ÿ∏ üéÅ</h1>
        
        <!-- ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ -->
        <div id="message" class="message"></div>
        
        <!-- ÿßŸÑÿµŸÜÿßÿØŸäŸÇ -->
        <div class="boxes-grid" id="boxes-container">
            <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÜÿßÿØŸäŸÇ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© JavaScript -->
        </div>
        
        <!-- ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÉŸÖ -->
        <div class="controls">
            <button id="single-btn" class="bet-button">
                üéØ ÿ∂ÿ±ÿ®ÿ© Ÿàÿßÿ≠ÿØÿ©<br><small>(50 ÿπŸÖŸÑÿ©)</small>
            </button>
            <button id="triple-btn" class="bet-button">
                ‚ö° ÿ´ŸÑÿßÿ´ ÿ∂ÿ±ÿ®ÿßÿ™<br><small>(150 ÿπŸÖŸÑÿ©)</small>
            </button>
            <button id="hammer-btn" class="bet-button">
                üî® ÿ∂ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ∑ÿ±ŸÇÿ©<br><small>(300 ÿπŸÖŸÑÿ©)</small>
            </button>
        </div>
        

    </div>

    <script>
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©
        let playerBalance = 1000;
        let isPlaying = false;
        let gameSession = null;
        let currentRound = 1; // ÿßŸÑÿ¨ŸàŸÑÿ© ÿßŸÑÿ≠ÿßŸÑŸäÿ© ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤

        // ÿπŸÜÿßÿµÿ± DOM
        const boxesContainer = document.getElementById('boxes-container');
        const messageDiv = document.getElementById('message');

        // ÿ£ŸÜŸàÿßÿπ ÿßŸÑÿ±ŸáÿßŸÜÿßÿ™
        const betTypes = {
            single: { cost: 50, boxes: 1, name: 'ÿ∂ÿ±ÿ®ÿ© Ÿàÿßÿ≠ÿØÿ©' },
            triple: { cost: 150, boxes: 3, name: 'ÿ´ŸÑÿßÿ´ ÿ∂ÿ±ÿ®ÿßÿ™' },
            hammer: { cost: 300, boxes: 5, name: 'ÿ∂ÿ±ÿ®ÿ© ÿßŸÑŸÖÿ∑ÿ±ŸÇÿ©' }
        };

        // ŸÖÿ≠ÿ™ŸàŸäÿßÿ™ ÿßŸÑÿµŸÜÿßÿØŸäŸÇ ÿßŸÑŸÖÿ™ŸÜŸàÿπÿ©
        const boxContents = {
            // ÿ¨Ÿàÿßÿ¶ÿ≤ ŸÖÿ±ÿ®ÿ≠ÿ© (40%)
            profitable: [
                { type: 'gold', emoji: 'üí∞', value: 200, name: 'ŸÉŸäÿ≥ ÿ∞Ÿáÿ®', probability: 0.15 },
                { type: 'gems', emoji: 'üíé', value: 500, name: 'ÿ¨ŸàŸáÿ±ÿ© ÿ´ŸÖŸäŸÜÿ©', probability: 0.10 },
                { type: 'treasure', emoji: 'üèÜ', value: 1000, name: 'ŸÉŸÜÿ≤ ÿ∞Ÿáÿ®Ÿä', probability: 0.05 },
                { type: 'coins', emoji: 'ü™ô', value: 150, name: 'ÿπŸÖŸÑÿßÿ™ ÿ∞Ÿáÿ®Ÿäÿ©', probability: 0.10 }
            ],
            // ÿ¨Ÿàÿßÿ¶ÿ≤ ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© (30%)
            medium: [
                { type: 'star', emoji: '‚≠ê', value: 100, name: 'ŸÜÿ¨ŸÖÿ© ŸÖÿ≠ÿ∏Ÿàÿ∏ÿ©', probability: 0.15 },
                { type: 'gift', emoji: 'üéÅ', value: 75, name: 'ŸáÿØŸäÿ© ÿµÿ∫Ÿäÿ±ÿ©', probability: 0.10 },
                { type: 'crystal', emoji: 'üîÆ', value: 120, name: 'ŸÉÿ±Ÿäÿ≥ÿ™ÿßŸÑ ÿ≥ÿ≠ÿ±Ÿä', probability: 0.05 }
            ],
            // ÿÆÿ≥ÿßÿ¶ÿ± (20%)
            losses: [
                { type: 'bomb', emoji: 'üí£', value: -100, name: 'ŸÇŸÜÿ®ŸÑÿ©!', probability: 0.08 },
                { type: 'trap', emoji: 'üï≥Ô∏è', value: -50, name: 'ŸÅÿÆ!', probability: 0.07 },
                { type: 'curse', emoji: 'üëª', value: -150, name: 'ŸÑÿπŸÜÿ©!', probability: 0.05 }
            ],
            // ŸÅÿßÿ±ÿ∫ (10%)
            empty: [
                { type: 'empty', emoji: '‚ùå', value: 0, name: 'ŸÅÿßÿ±ÿ∫', probability: 0.10 }
            ]
        };

        // ÿ±ÿ≥ÿßÿ¶ŸÑ ÿ™ÿ¥ŸàŸäŸÇ ŸÑŸÑÿµŸÜÿßÿØŸäŸÇ
        const excitementMessages = [
            "üéÅ ÿµŸÜÿØŸàŸÇ ŸÖŸÑŸäÿ° ÿ®ÿßŸÑŸÖŸÅÿßÿ¨ÿ¢ÿ™!",
            "‚ú® ŸÖÿßÿ∞ÿß ŸäÿÆÿ®ÿ¶ Ÿáÿ∞ÿß ÿßŸÑÿµŸÜÿØŸàŸÇÿü",
            "üé≤ ÿ≠ÿ∏ŸÉ ÿßŸÑŸäŸàŸÖ ŸÇÿØ Ÿäÿ∫Ÿäÿ± ŸÉŸÑ ÿ¥Ÿäÿ°!",
            "üí´ ÿßÿ≥ÿ™ÿπÿØ ŸÑŸÑŸÖŸÅÿßÿ¨ÿ£ÿ©!",
            "üåü ÿµŸÜÿØŸàŸÇ ÿßŸÑÿ£ÿ≠ŸÑÿßŸÖ ŸäŸÜÿ™ÿ∏ÿ±ŸÉ!",
            "üéä ŸÖŸÅÿßÿ¨ÿ¢ÿ™ ŸÑÿß ÿ™ŸèÿµÿØŸÇ!",
            "üéà ÿ≠ÿßŸÜ ŸàŸÇÿ™ ÿßŸÑÿ≠ÿ∏ ÿßŸÑÿ∞Ÿáÿ®Ÿä!",
            "üéØ ÿßÿÆÿ™Ÿäÿßÿ±ŸÉ ŸÇÿØ ŸäŸÉŸàŸÜ ÿßŸÑÿ£ŸÅÿ∂ŸÑ!"
        ];

        // ÿØÿßŸÑÿ© ÿ•ÿ∂ÿßŸÅÿ© ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ¥ÿÆŸäÿµ (ŸÖÿπÿ∑ŸÑÿ© ŸÑŸÑÿ•ŸÜÿ™ÿßÿ¨)
        function addDebug(message) {
            // ÿ™ŸÖ ÿ™ÿπÿ∑ŸäŸÑ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ ŸÑÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        }

        // ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ±ÿ≥ÿßÿ¶ŸÑ
        function showMessage(text, type = 'info') {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
        }

        // ÿØÿßŸÑÿ© ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ
        function updateBalance(newBalance) {
            playerBalance = newBalance;

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ŸÅŸä ŸáŸäÿØÿ± ÿßŸÑŸÑÿßÿπÿ®
            if (window.playerHeader) {
                window.playerHeader.updateBalance(newBalance);
            }
        }

        // ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÜÿßÿØŸäŸÇ
        function createBoxes() {
            addDebug('ÿ®ÿØÿ° ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÜÿßÿØŸäŸÇ...');

            if (!boxesContainer) {
                addDebug('‚ùå ÿÆÿ∑ÿ£: ÿπŸÜÿµÿ± ÿßŸÑÿµŸÜÿßÿØŸäŸÇ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ!');
                return;
            }

            boxesContainer.innerHTML = '';

            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'box';
                box.id = `box-${i}`;
                box.textContent = 'üì¶';
                box.onclick = () => addDebug(`ÿ™ŸÖ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿµŸÜÿØŸàŸÇ ${i + 1}`);
                boxesContainer.appendChild(box);
            }

            addDebug(`‚úÖ ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° 9 ÿµŸÜÿßÿØŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠`);
        }

        // ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ≠ÿ™ŸàŸâ ÿπÿ¥Ÿàÿßÿ¶Ÿä ŸÑŸÑÿµŸÜÿØŸàŸÇ
        function getRandomBoxContent() {
            const allContents = [
                ...boxContents.profitable,
                ...boxContents.medium,
                ...boxContents.losses,
                ...boxContents.empty
            ];

            const random = Math.random();
            let cumulativeProbability = 0;

            for (const content of allContents) {
                cumulativeProbability += content.probability;
                if (random <= cumulativeProbability) {
                    return content;
                }
            }

            // ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä - ÿ•ÿ±ÿ¨ÿßÿπ ŸÖÿ≠ÿ™ŸàŸâ ŸÅÿßÿ±ÿ∫
            return boxContents.empty[0];
        }

        // ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ¨ŸàŸÑÿßÿ™ ŸÑÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿπŸÜÿØ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±
        function checkRoundProgression() {
            // ŸÉŸÑ 10 ÿ£ŸÑÿπÿßÿ®ÿå ÿ≤ŸäÿßÿØÿ© ÿßŸÑÿ¨ŸàŸÑÿ© Ÿàÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ŸÇŸÑŸäŸÑÿßŸã
            const gamesPlayed = parseInt(localStorage.getItem('lucky-boxes-games-played') || '0');
            const newGamesCount = gamesPlayed + 1;
            localStorage.setItem('lucky-boxes-games-played', newGamesCount.toString());

            const newRound = Math.floor(newGamesCount / 10) + 1;
            if (newRound > currentRound) {
                currentRound = newRound;
                showMessage(`üéØ ÿßŸÑÿ¨ŸàŸÑÿ© ${currentRound} - ÿ™ÿ≠ÿØŸä ÿ£ŸÉÿ®ÿ±!`, 'info');
            }
        }

        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ¨ÿßÿ¶ÿ≤ÿ© ŸÖÿπ ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±
        function calculateReward(baseValue) {
            if (currentRound === 1) return baseValue;

            const reductionPercentage = (currentRound - 1) * 10;
            const maxReduction = 50; // ÿ≠ÿØ ÿ£ŸÇÿµŸâ 50% ÿ™ŸÇŸÑŸäŸÑ
            const actualReduction = Math.min(reductionPercentage, maxReduction);

            return Math.floor(baseValue * (100 - actualReduction) / 100);
        }

        // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿ®ÿµÿ±Ÿäÿ© ŸÑŸÑÿµŸÜÿßÿØŸäŸÇ
        function addBoxAnimation(box, type) {
            box.style.transform = 'scale(1.2)';
            box.style.transition = 'all 0.3s ease';

            setTimeout(() => {
                box.style.transform = 'scale(1)';
            }, 300);

            // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ£ÿ´Ÿäÿ± ŸàŸÖŸäÿ∂ ŸÑŸÑÿ¨Ÿàÿßÿ¶ÿ≤ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ©
            if (type === 'big-win') {
                box.style.animation = 'pulse 0.5s ease-in-out 3';
            }
        }

        // ÿØÿßŸÑÿ© ÿßŸÑŸÑÿπÿ® ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© ŸÖÿπ ÿßŸÑŸÅÿ™ÿ≠ ÿßŸÑÿπÿ¥Ÿàÿßÿ¶Ÿä
        async function playGame(type) {
            if (isPlaying) {
                showMessage('ÿßŸÑŸÑÿπÿ®ÿ© ŸÇŸäÿØ ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ...', 'info');
                return;
            }

            const bet = betTypes[type];
            if (!bet) {
                showMessage('ŸÜŸàÿπ ÿ±ŸáÿßŸÜ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠!', 'error');
                return;
            }

            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿßŸÑŸÑÿπÿ®
            if (window.gameEconomy && gameSession) {
                const canPlayResult = window.gameEconomy.canPlay(bet.cost);
                if (!canPlayResult.canPlay) {
                    showMessage(canPlayResult.reason, 'error');
                    return;
                }
            } else if (playerBalance < bet.cost) {
                showMessage('ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅŸä!', 'error');
                return;
            }

            isPlaying = true;

            // ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
            document.getElementById('single-btn').disabled = true;
            document.getElementById('triple-btn').disabled = true;
            document.getElementById('hammer-btn').disabled = true;

            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ™ŸÇÿØŸÖ ÿßŸÑÿ¨ŸàŸÑÿßÿ™
            checkRoundProgression();

            showMessage(`üéÆ ÿ®ÿØÿ° ${bet.name}... ÿßÿ≥ÿ™ÿπÿØ ŸÑŸÑŸÖŸÅÿßÿ¨ÿ¢ÿ™!`, 'info');

            // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÜÿßÿØŸäŸÇ
            createBoxes();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ¥ŸàŸäŸÇ ÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
            const randomMessage = excitementMessages[Math.floor(Math.random() * excitementMessages.length)];
            showMessage(randomMessage, 'info');
            await new Promise(resolve => setTimeout(resolve, 800));

            // ŸÅÿ™ÿ≠ ÿßŸÑÿµŸÜÿßÿØŸäŸÇ ÿπÿ¥Ÿàÿßÿ¶ŸäÿßŸã
            const boxes = Array.from(document.querySelectorAll('.box'));
            let totalWin = 0;
            let totalLoss = 0;
            const results = [];

            for (let i = 0; i < bet.boxes && boxes.length > 0; i++) {
                // ÿßÿÆÿ™Ÿäÿßÿ± ÿµŸÜÿØŸàŸÇ ÿπÿ¥Ÿàÿßÿ¶Ÿä
                const randomIndex = Math.floor(Math.random() * boxes.length);
                const selectedBox = boxes[randomIndex];
                boxes.splice(randomIndex, 1); // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿµŸÜÿØŸàŸÇ ŸÖŸÜ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©

                // ÿßÿÆÿ™Ÿäÿßÿ± ŸÖÿ≠ÿ™ŸàŸâ ÿπÿ¥Ÿàÿßÿ¶Ÿä
                const content = getRandomBoxContent();
                const finalValue = calculateReward(content.value);

                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÜÿØŸàŸÇ
                selectedBox.innerHTML = `
                    <div class="box-content">
                        <div class="box-emoji">${content.emoji}</div>
                        <div class="box-value">${finalValue > 0 ? '+' : ''}${finalValue}</div>
                        <div class="box-name">${content.name}</div>
                    </div>
                `;

                if (finalValue > 0) {
                    selectedBox.className = 'box opened win';
                    totalWin += finalValue;
                } else if (finalValue < 0) {
                    selectedBox.className = 'box opened loss';
                    totalLoss += Math.abs(finalValue);
                } else {
                    selectedBox.className = 'box opened empty';
                }

                results.push({ content, value: finalValue });

                // ÿ™ÿ£ÿ´Ÿäÿ± ÿµŸàÿ™Ÿä Ÿàÿ®ÿµÿ±Ÿä
                selectedBox.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    selectedBox.style.transform = 'scale(1)';
                }, 300);

                await new Promise(resolve => setTimeout(resolve, 800));
            }

            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑŸÜŸáÿßÿ¶Ÿäÿ©
            const netResult = totalWin - totalLoss;
            let resultMessage = '';

            if (netResult > 0) {
                resultMessage = `üéâ ŸÖÿ®ÿ±ŸàŸÉ! ÿ±ÿ®ÿ≠ÿ™ ${netResult} ÿπŸÖŸÑÿ© ŸÖŸÜ ÿßŸÑÿµŸÜÿßÿØŸäŸÇ!`;
                showMessage(resultMessage, 'success');
            } else if (netResult < 0) {
                resultMessage = `üòî ÿÆÿ≥ÿ±ÿ™ ${Math.abs(netResult)} ÿπŸÖŸÑÿ©`;
                showMessage(resultMessage, 'error');
            } else {
                resultMessage = `ü§∑‚Äç‚ôÇÔ∏è ŸÑÿß ÿ±ÿ®ÿ≠ ŸàŸÑÿß ÿÆÿ≥ÿßÿ±ÿ© Ÿáÿ∞Ÿá ÿßŸÑŸÖÿ±ÿ©`;
                showMessage(resultMessage, 'info');
            }

            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ
            try {
                if (window.gameEconomy && gameSession) {
                    const gameResult = {
                        isWin: netResult > 0,
                        winAmount: Math.max(0, netResult),
                        lossAmount: Math.max(0, Math.abs(netResult)) + bet.cost,
                        totalWin: totalWin,
                        totalBet: bet.cost,
                        gameType: 'lucky-boxes',
                        round: currentRound,
                        boxesOpened: bet.boxes
                    };

                    const balanceUpdate = await window.gameEconomy.updatePlayerBalance(gameResult);
                    if (balanceUpdate.success) {
                        playerBalance = balanceUpdate.newBalance;
                        updateBalance(playerBalance);
                    }
                } else {
                    // ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ≠ŸÑŸä
                    playerBalance += netResult - bet.cost;
                    updateBalance(playerBalance);
                }
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ:', error);
                showMessage('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ', 'error');
            }

            // ÿ•ÿπÿßÿØÿ© ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ±
            setTimeout(() => {
                document.getElementById('single-btn').disabled = false;
                document.getElementById('triple-btn').disabled = false;
                document.getElementById('hammer-btn').disabled = false;
                isPlaying = false;
            }, 3000);
        }

        // ÿØÿßŸÑÿ© ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        function goHome() {
            addDebug('ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©');

            // ÿ•ŸÜŸáÿßÿ° ÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÑÿπÿ® ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ŸÖŸàÿ¨ŸàÿØÿ©
            if (window.gameEconomy && gameSession) {
                window.gameEconomy.endGameSession();
            }

            window.location.href = '/';
        }

        // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÑÿ™ŸàÿßŸÅŸÇ ŸÖÿπ player-header
        function goToMainPage() {
            goHome();
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', async function() {
            addDebug('üéÆ ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©...');

            try {
                // ÿ™ŸáŸäÿ¶ÿ© ŸáŸäÿØÿ± ÿßŸÑŸÑÿßÿπÿ®
                if (window.playerHeader) {
                    await window.playerHeader.init();
                    const headerContainer = document.getElementById('player-header-container');
                    if (headerContainer) {
                        window.playerHeader.insertHeader(headerContainer);
                        addDebug('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸáŸäÿØÿ± ÿßŸÑŸÑÿßÿπÿ®');

                        // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ±ÿµŸäÿØ ÿßŸÑŸÑÿßÿπÿ® ŸÖŸÜ ÿßŸÑŸáŸäÿØÿ±
                        playerBalance = window.playerHeader.balance || 1000;
                    }
                } else {
                    addDebug('‚ö†Ô∏è playerHeader ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±');
                }

                // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
                if (window.gameEconomy) {
                    try {
                        gameSession = await window.gameEconomy.initGameSession('lucky-boxes', 50);
                        addDebug('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä');

                        // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ±ÿµŸäÿØ ŸÖŸÜ ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä
                        if (gameSession && gameSession.currentBalance) {
                            playerBalance = gameSession.currentBalance;
                            updateBalance(playerBalance);
                        }
                    } catch (economyError) {
                        addDebug(`‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿßŸÇÿ™ÿµÿßÿØŸä: ${economyError.message}`);
                    }
                } else {
                    addDebug('‚ö†Ô∏è gameEconomy ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±');
                }

                // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÜÿßÿØŸäŸÇ ÿßŸÑÿ£ŸàŸÑŸäÿ©
                createBoxes();

                // ÿ•ÿ∂ÿßŸÅÿ© event listeners ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ±
                document.getElementById('single-btn').addEventListener('click', () => playGame('single'));
                document.getElementById('triple-btn').addEventListener('click', () => playGame('triple'));
                document.getElementById('hammer-btn').addEventListener('click', () => playGame('hammer'));

                showMessage('ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ ŸÅŸä ŸÑÿπÿ®ÿ© ÿµŸÜÿßÿØŸäŸÇ ÿßŸÑÿ≠ÿ∏! üéÅ', 'success');
                addDebug('‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®ŸÜÿ¨ÿßÿ≠');

            } catch (error) {
                addDebug(`‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ŸáŸäÿ¶ÿ©: ${error.message}`);
                showMessage('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑÿπÿ®ÿ©', 'error');

                // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÜÿßÿØŸäŸÇ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ
                try {
                    createBoxes();
                } catch (boxError) {
                    addDebug(`‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿµŸÜÿßÿØŸäŸÇ: ${boxError.message}`);
                }
            }
        });

        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
        window.addEventListener('error', function(event) {
            addDebug(`‚ùå ÿÆÿ∑ÿ£ JavaScript: ${event.message} ŸÅŸä ${event.filename}:${event.lineno}`);
        });

        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ©
        window.addEventListener('load', function() {
            addDebug('üîç ŸÅÿ≠ÿµ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÖÿ≠ŸÖŸÑÿ©...');

            if (typeof window.playerHeader === 'undefined') {
                addDebug('‚ö†Ô∏è player-header.js ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá');
            } else {
                addDebug('‚úÖ player-header.js ŸÖÿ≠ŸÖŸÑ');
            }

            if (typeof window.gameEconomy === 'undefined') {
                addDebug('‚ö†Ô∏è game-economy.js ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá');
            } else {
                addDebug('‚úÖ game-economy.js ŸÖÿ≠ŸÖŸÑ');
            }
        });

        addDebug('ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ JavaScript');
    </script>
</body>
</html>
