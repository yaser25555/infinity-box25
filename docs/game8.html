<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚</title>
    <script src="js/translations.js"></script>
    <script src="js/game-economy.js"></script>
    <script src="js/player-header.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #2c5282 100%);
            color: white;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .player-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .player-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .player-avatar {
            width: 50px;
            height: 50px;
            background: #ffd700;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
        }
        
        .player-data {
            text-align: left;
        }
        
        .player-name {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .player-balance {
            color: #ffd700;
            font-weight: bold;
        }
        
        .home-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
        }
        
        .home-btn:hover {
            background: #059669;
        }
        
        .game-title {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 30px;
        }
        
        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 400px;
            margin: 30px auto;
        }
        
        .box {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid rgba(255, 255, 255, 0.3);
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .box:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.5);
        }
        
        .box.opened {
            background: #666;
            cursor: default;
        }
        
        .box.win {
            background: #10b981;
        }
        
        .box.loss {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .box.empty {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: #d1d5db;
        }

        .box-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            width: 100%;
            height: 100%;
            padding: 4px;
        }

        .box-emoji {
            font-size: 1.2em;
            margin-bottom: 2px;
        }

        .box-value {
            font-size: 0.5em;
            font-weight: bold;
            margin-bottom: 1px;
            line-height: 1;
        }

        .box-name {
            font-size: 0.25em;
            opacity: 0.8;
            line-height: 1;
            text-align: center;
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .box.big-win {
            animation: pulse 0.5s ease-in-out 3;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .bet-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        .bet-button:hover {
            background: #059669;
            transform: translateY(-2px);
        }
        
        .bet-button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .message.success { color: #10b981; }
        .message.error { color: #ef4444; }
        .message.info { color: #ffd700; }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                max-width: 100vw;
                padding: 8px;
                margin: 2px;
                box-sizing: border-box;
            }

            .header {
                margin-bottom: 5px;
                padding: 4px 6px;
                flex-wrap: wrap;
            }

            .game-title {
                font-size: 0.9em;
                order: 1;
                flex: 1;
                text-align: center;
            }

            .back-btn {
                width: 30px;
                height: 30px;
                font-size: 1em;
                order: 0;
            }

            .stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
                margin: 5px 0;
            }

            .stat-item {
                padding: 4px 6px;
                border-radius: 6px;
            }

            .stat-value {
                font-size: 1em;
            }

            .stat-label {
                font-size: 0.7em;
            }

            .boxes-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin: 10px 0;
                max-width: 100%;
            }

            .box {
                width: 80px;
                height: 80px;
                font-size: 2em;
                border-radius: 8px;
            }

            .box-number {
                font-size: 0.6em;
                top: 2px;
                left: 2px;
                width: 16px;
                height: 16px;
            }

            .controls {
                gap: 4px;
                margin: 8px 0;
                flex-wrap: wrap;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 0.75em;
                border-radius: 8px;
                flex: 1;
                min-width: 100px;
            }

            .result-message {
                padding: 8px;
                font-size: 0.8em;
                margin: 8px 0;
                border-radius: 8px;
            }

            .debug-panel {
                font-size: 0.7em;
                padding: 6px;
                max-height: 120px;
            }
        }

        @media (max-width: 480px) {
            .boxes-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .box {
                width: 70px;
                height: 70px;
                font-size: 1.8em;
            }

            .controls {
                flex-direction: column;
                align-items: center;
                gap: 6px;
            }

            .control-btn {
                width: 100%;
                max-width: 200px;
                margin: 2px 0;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ -->
        <div id="player-header-container">
            <!-- Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ù‡ÙŠØ¯Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù‡Ù†Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
        </div>
        
        <h1 class="game-title">ğŸ ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø­Ø¸ ğŸ</h1>
        
        <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ -->
        <div id="message" class="message"></div>
        
        <!-- Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ -->
        <div class="boxes-grid" id="boxes-container">
            <!-- Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
        </div>
        
        <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
        <div class="controls">
            <button id="single-btn" class="bet-button">
                ğŸ¯ Ø¶Ø±Ø¨Ø© ÙˆØ§Ø­Ø¯Ø©<br><small>(50 Ø¹Ù…Ù„Ø©)</small>
            </button>
            <button id="triple-btn" class="bet-button">
                âš¡ Ø«Ù„Ø§Ø« Ø¶Ø±Ø¨Ø§Øª<br><small>(150 Ø¹Ù…Ù„Ø©)</small>
            </button>
            <button id="hammer-btn" class="bet-button">
                ğŸ”¨ Ø¶Ø±Ø¨Ø© Ø§Ù„Ù…Ø·Ø±Ù‚Ø©<br><small>(300 Ø¹Ù…Ù„Ø©)</small>
            </button>
        </div>
        

    </div>

    <script>
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
        let playerBalance = 1000;
        let isPlaying = false;
        let gameSession = null;
        let currentRound = 1; // Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø²

        // Ø¹Ù†Ø§ØµØ± DOM
        const boxesContainer = document.getElementById('boxes-container');
        const messageDiv = document.getElementById('message');

        // Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø±Ù‡Ø§Ù†Ø§Øª
        const betTypes = {
            single: { cost: 50, boxes: 1, name: 'Ø¶Ø±Ø¨Ø© ÙˆØ§Ø­Ø¯Ø©' },
            triple: { cost: 150, boxes: 3, name: 'Ø«Ù„Ø§Ø« Ø¶Ø±Ø¨Ø§Øª' },
            hammer: { cost: 300, boxes: 5, name: 'Ø¶Ø±Ø¨Ø© Ø§Ù„Ù…Ø·Ø±Ù‚Ø©' }
        };

        // Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ù…ØªÙ†ÙˆØ¹Ø©
        const boxContents = {
            // Ø¬ÙˆØ§Ø¦Ø² Ù…Ø±Ø¨Ø­Ø© (40%)
            profitable: [
                { type: 'gold', emoji: 'ğŸ’°', value: 200, name: 'ÙƒÙŠØ³ Ø°Ù‡Ø¨', probability: 0.15 },
                { type: 'gems', emoji: 'ğŸ’', value: 500, name: 'Ø¬ÙˆÙ‡Ø±Ø© Ø«Ù…ÙŠÙ†Ø©', probability: 0.10 },
                { type: 'treasure', emoji: 'ğŸ†', value: 1000, name: 'ÙƒÙ†Ø² Ø°Ù‡Ø¨ÙŠ', probability: 0.05 },
                { type: 'coins', emoji: 'ğŸª™', value: 150, name: 'Ø¹Ù…Ù„Ø§Øª Ø°Ù‡Ø¨ÙŠØ©', probability: 0.10 }
            ],
            // Ø¬ÙˆØ§Ø¦Ø² Ù…ØªÙˆØ³Ø·Ø© (30%)
            medium: [
                { type: 'star', emoji: 'â­', value: 100, name: 'Ù†Ø¬Ù…Ø© Ù…Ø­Ø¸ÙˆØ¸Ø©', probability: 0.15 },
                { type: 'gift', emoji: 'ğŸ', value: 75, name: 'Ù‡Ø¯ÙŠØ© ØµØºÙŠØ±Ø©', probability: 0.10 },
                { type: 'crystal', emoji: 'ğŸ”®', value: 120, name: 'ÙƒØ±ÙŠØ³ØªØ§Ù„ Ø³Ø­Ø±ÙŠ', probability: 0.05 }
            ],
            // Ø®Ø³Ø§Ø¦Ø± (20%)
            losses: [
                { type: 'bomb', emoji: 'ğŸ’£', value: -100, name: 'Ù‚Ù†Ø¨Ù„Ø©!', probability: 0.08 },
                { type: 'trap', emoji: 'ğŸ•³ï¸', value: -50, name: 'ÙØ®!', probability: 0.07 },
                { type: 'curse', emoji: 'ğŸ‘»', value: -150, name: 'Ù„Ø¹Ù†Ø©!', probability: 0.05 }
            ],
            // ÙØ§Ø±Øº (10%)
            empty: [
                { type: 'empty', emoji: 'âŒ', value: 0, name: 'ÙØ§Ø±Øº', probability: 0.10 }
            ]
        };

        // Ø±Ø³Ø§Ø¦Ù„ ØªØ´ÙˆÙŠÙ‚ Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
        const excitementMessages = [
            "ğŸ ØµÙ†Ø¯ÙˆÙ‚ Ù…Ù„ÙŠØ¡ Ø¨Ø§Ù„Ù…ÙØ§Ø¬Ø¢Øª!",
            "âœ¨ Ù…Ø§Ø°Ø§ ÙŠØ®Ø¨Ø¦ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ØŸ",
            "ğŸ² Ø­Ø¸Ùƒ Ø§Ù„ÙŠÙˆÙ… Ù‚Ø¯ ÙŠØºÙŠØ± ÙƒÙ„ Ø´ÙŠØ¡!",
            "ğŸ’« Ø§Ø³ØªØ¹Ø¯ Ù„Ù„Ù…ÙØ§Ø¬Ø£Ø©!",
            "ğŸŒŸ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£Ø­Ù„Ø§Ù… ÙŠÙ†ØªØ¸Ø±Ùƒ!",
            "ğŸŠ Ù…ÙØ§Ø¬Ø¢Øª Ù„Ø§ ØªÙØµØ¯Ù‚!",
            "ğŸˆ Ø­Ø§Ù† ÙˆÙ‚Øª Ø§Ù„Ø­Ø¸ Ø§Ù„Ø°Ù‡Ø¨ÙŠ!",
            "ğŸ¯ Ø§Ø®ØªÙŠØ§Ø±Ùƒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø£ÙØ¶Ù„!"
        ];

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ´Ø®ÙŠØµ (Ù…Ø¹Ø·Ù„Ø© Ù„Ù„Ø¥Ù†ØªØ§Ø¬)
        function addDebug(message) {
            // ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ´Ø®ÙŠØµ Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showMessage(text, type = 'info') {
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
        function updateBalance(newBalance) {
            playerBalance = newBalance;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ù‡ÙŠØ¯Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨
            if (window.playerHeader) {
                window.playerHeader.updateBalance(newBalance);
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
        function createBoxes() {
            addDebug('Ø¨Ø¯Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚...');

            if (!boxesContainer) {
                addDebug('âŒ Ø®Ø·Ø£: Ø¹Ù†ØµØ± Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                return;
            }

            boxesContainer.innerHTML = '';

            for (let i = 0; i < 9; i++) {
                const box = document.createElement('div');
                box.className = 'box';
                box.id = `box-${i}`;
                box.textContent = 'ğŸ“¦';
                box.onclick = () => addDebug(`ØªÙ… Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ ${i + 1}`);
                boxesContainer.appendChild(box);
            }

            addDebug(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ 9 ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­`);
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­ØªÙˆÙ‰ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚
        function getRandomBoxContent() {
            const allContents = [
                ...boxContents.profitable,
                ...boxContents.medium,
                ...boxContents.losses,
                ...boxContents.empty
            ];

            const random = Math.random();
            let cumulativeProbability = 0;

            for (const content of allContents) {
                cumulativeProbability += content.probability;
                if (random <= cumulativeProbability) {
                    return content;
                }
            }

            // Ø§Ø­ØªÙŠØ§Ø·ÙŠ - Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø­ØªÙˆÙ‰ ÙØ§Ø±Øº
            return boxContents.empty[0];
        }

        // ØªØªØ¨Ø¹ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ±Ø§Ø±
        function checkRoundProgression() {
            // ÙƒÙ„ 10 Ø£Ù„Ø¹Ø§Ø¨ØŒ Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¬ÙˆÙ„Ø© ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² Ù‚Ù„ÙŠÙ„Ø§Ù‹
            const gamesPlayed = parseInt(localStorage.getItem('lucky-boxes-games-played') || '0');
            const newGamesCount = gamesPlayed + 1;
            localStorage.setItem('lucky-boxes-games-played', newGamesCount.toString());

            const newRound = Math.floor(newGamesCount / 10) + 1;
            if (newRound > currentRound) {
                currentRound = newRound;
                showMessage(`ğŸ¯ Ø§Ù„Ø¬ÙˆÙ„Ø© ${currentRound} - ØªØ­Ø¯ÙŠ Ø£ÙƒØ¨Ø±!`, 'info');
            }
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ù…Ø¹ ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙƒØ±Ø§Ø±
        function calculateReward(baseValue) {
            if (currentRound === 1) return baseValue;

            const reductionPercentage = (currentRound - 1) * 10;
            const maxReduction = 50; // Ø­Ø¯ Ø£Ù‚ØµÙ‰ 50% ØªÙ‚Ù„ÙŠÙ„
            const actualReduction = Math.min(reductionPercentage, maxReduction);

            return Math.floor(baseValue * (100 - actualReduction) / 100);
        }

        // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ±Ø§Øª Ø¨ØµØ±ÙŠØ© Ù„Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
        function addBoxAnimation(box, type) {
            box.style.transform = 'scale(1.2)';
            box.style.transition = 'all 0.3s ease';

            setTimeout(() => {
                box.style.transform = 'scale(1)';
            }, 300);

            // Ø¥Ø¶Ø§ÙØ© ØªØ£Ø«ÙŠØ± ÙˆÙ…ÙŠØ¶ Ù„Ù„Ø¬ÙˆØ§Ø¦Ø² Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
            if (type === 'big-win') {
                box.style.animation = 'pulse 0.5s ease-in-out 3';
            }
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ù…Ø­Ø³Ù†Ø© Ù…Ø¹ Ø§Ù„ÙØªØ­ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
        async function playGame(type) {
            if (isPlaying) {
                showMessage('Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‚ÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„...', 'info');
                return;
            }

            const bet = betTypes[type];
            if (!bet) {
                showMessage('Ù†ÙˆØ¹ Ø±Ù‡Ø§Ù† ØºÙŠØ± ØµØ­ÙŠØ­!', 'error');
                return;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨
            if (window.gameEconomy && gameSession) {
                const canPlayResult = window.gameEconomy.canPlay(bet.cost);
                if (!canPlayResult.canPlay) {
                    showMessage(canPlayResult.reason, 'error');
                    return;
                }
            } else if (playerBalance < bet.cost) {
                showMessage('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ!', 'error');
                return;
            }

            isPlaying = true;

            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.getElementById('single-btn').disabled = true;
            document.getElementById('triple-btn').disabled = true;
            document.getElementById('hammer-btn').disabled = true;

            // ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ‚Ø¯Ù… Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
            checkRoundProgression();

            showMessage(`ğŸ® Ø¨Ø¯Ø¡ ${bet.name}... Ø§Ø³ØªØ¹Ø¯ Ù„Ù„Ù…ÙØ§Ø¬Ø¢Øª!`, 'info');

            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
            createBoxes();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // Ø±Ø³Ø§Ù„Ø© ØªØ´ÙˆÙŠÙ‚ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            const randomMessage = excitementMessages[Math.floor(Math.random() * excitementMessages.length)];
            showMessage(randomMessage, 'info');
            await new Promise(resolve => setTimeout(resolve, 800));

            // ÙØªØ­ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
            const boxes = Array.from(document.querySelectorAll('.box'));
            let totalWin = 0;
            let totalLoss = 0;
            const results = [];

            for (let i = 0; i < bet.boxes && boxes.length > 0; i++) {
                // Ø§Ø®ØªÙŠØ§Ø± ØµÙ†Ø¯ÙˆÙ‚ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                const randomIndex = Math.floor(Math.random() * boxes.length);
                const selectedBox = boxes[randomIndex];
                boxes.splice(randomIndex, 1); // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

                // Ø§Ø®ØªÙŠØ§Ø± Ù…Ø­ØªÙˆÙ‰ Ø¹Ø´ÙˆØ§Ø¦ÙŠ
                const content = getRandomBoxContent();
                const finalValue = calculateReward(content.value);

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                selectedBox.innerHTML = `
                    <div class="box-content">
                        <div class="box-emoji">${content.emoji}</div>
                        <div class="box-value">${finalValue > 0 ? '+' : ''}${finalValue}</div>
                        <div class="box-name">${content.name}</div>
                    </div>
                `;

                if (finalValue > 0) {
                    selectedBox.className = 'box opened win';
                    totalWin += finalValue;
                } else if (finalValue < 0) {
                    selectedBox.className = 'box opened loss';
                    totalLoss += Math.abs(finalValue);
                } else {
                    selectedBox.className = 'box opened empty';
                }

                results.push({ content, value: finalValue });

                // ØªØ£Ø«ÙŠØ± ØµÙˆØªÙŠ ÙˆØ¨ØµØ±ÙŠ
                selectedBox.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    selectedBox.style.transform = 'scale(1)';
                }, 300);

                await new Promise(resolve => setTimeout(resolve, 800));
            }

            // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            const netResult = totalWin - totalLoss;
            let resultMessage = '';

            if (netResult > 0) {
                resultMessage = `ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø±Ø¨Ø­Øª ${netResult} Ø¹Ù…Ù„Ø© Ù…Ù† Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚!`;
                showMessage(resultMessage, 'success');
            } else if (netResult < 0) {
                resultMessage = `ğŸ˜” Ø®Ø³Ø±Øª ${Math.abs(netResult)} Ø¹Ù…Ù„Ø©`;
                showMessage(resultMessage, 'error');
            } else {
                resultMessage = `ğŸ¤·â€â™‚ï¸ Ù„Ø§ Ø±Ø¨Ø­ ÙˆÙ„Ø§ Ø®Ø³Ø§Ø±Ø© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø©`;
                showMessage(resultMessage, 'info');
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯
            try {
                if (window.gameEconomy && gameSession) {
                    const gameResult = {
                        isWin: netResult > 0,
                        winAmount: Math.max(0, netResult),
                        lossAmount: Math.max(0, Math.abs(netResult)) + bet.cost,
                        totalWin: totalWin,
                        totalBet: bet.cost,
                        gameType: 'lucky-boxes',
                        round: currentRound,
                        boxesOpened: bet.boxes
                    };

                    const balanceUpdate = await window.gameEconomy.updatePlayerBalance(gameResult);
                    if (balanceUpdate.success) {
                        playerBalance = balanceUpdate.newBalance;
                        updateBalance(playerBalance);
                    }
                } else {
                    // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
                    playerBalance += netResult - bet.cost;
                    updateBalance(playerBalance);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯:', error);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯', 'error');
            }

            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            setTimeout(() => {
                document.getElementById('single-btn').disabled = false;
                document.getElementById('triple-btn').disabled = false;
                document.getElementById('hammer-btn').disabled = false;
                isPlaying = false;
            }, 3000);
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function goHome() {
            addDebug('Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©');

            // Ø¥Ù†Ù‡Ø§Ø¡ Ø¬Ù„Ø³Ø© Ø§Ù„Ù„Ø¹Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (window.gameEconomy && gameSession) {
                window.gameEconomy.endGameSession();
            }

            window.location.href = '/';
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ player-header
        function goToMainPage() {
            goHome();
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', async function() {
            addDebug('ğŸ® Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...');

            try {
                // ØªÙ‡ÙŠØ¦Ø© Ù‡ÙŠØ¯Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨
                if (window.playerHeader) {
                    await window.playerHeader.init();
                    const headerContainer = document.getElementById('player-header-container');
                    if (headerContainer) {
                        window.playerHeader.insertHeader(headerContainer);
                        addDebug('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‡ÙŠØ¯Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨');

                        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø±
                        playerBalance = window.playerHeader.balance || 1000;
                    }
                } else {
                    addDebug('âš ï¸ playerHeader ØºÙŠØ± Ù…ØªÙˆÙØ±');
                }

                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
                if (window.gameEconomy) {
                    try {
                        gameSession = await window.gameEconomy.initGameSession('lucky-boxes', 50);
                        addDebug('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ');

                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ
                        if (gameSession && gameSession.currentBalance) {
                            playerBalance = gameSession.currentBalance;
                            updateBalance(playerBalance);
                        }
                    } catch (economyError) {
                        addDebug(`âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ù‚ØªØµØ§Ø¯ÙŠ: ${economyError.message}`);
                    }
                } else {
                    addDebug('âš ï¸ gameEconomy ØºÙŠØ± Ù…ØªÙˆÙØ±');
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„ÙŠØ©
                createBoxes();

                // Ø¥Ø¶Ø§ÙØ© event listeners Ù„Ù„Ø£Ø²Ø±Ø§Ø±
                document.getElementById('single-btn').addEventListener('click', () => playGame('single'));
                document.getElementById('triple-btn').addEventListener('click', () => playGame('triple'));
                document.getElementById('hammer-btn').addEventListener('click', () => playGame('hammer'));

                showMessage('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù„Ø¹Ø¨Ø© ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø­Ø¸! ğŸ', 'success');
                addDebug('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­');

            } catch (error) {
                addDebug(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©: ${error.message}`);
                showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨Ø©', 'error');

                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                try {
                    createBoxes();
                } catch (boxError) {
                    addDebug(`âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚: ${boxError.message}`);
                }
            }
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        window.addEventListener('error', function(event) {
            addDebug(`âŒ Ø®Ø·Ø£ JavaScript: ${event.message} ÙÙŠ ${event.filename}:${event.lineno}`);
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
        window.addEventListener('load', function() {
            addDebug('ğŸ” ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©...');

            if (typeof window.playerHeader === 'undefined') {
                addDebug('âš ï¸ player-header.js Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡');
            } else {
                addDebug('âœ… player-header.js Ù…Ø­Ù…Ù„');
            }

            if (typeof window.gameEconomy === 'undefined') {
                addDebug('âš ï¸ game-economy.js Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡');
            } else {
                addDebug('âœ… game-economy.js Ù…Ø­Ù…Ù„');
            }
        });

        addDebug('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù JavaScript');
    </script>
</body>
</html>
